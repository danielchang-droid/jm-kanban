
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>JM Kanban ‚Äî Team</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #0b0c10;
      --panel: #11131a;
      --panel-2: #151824;
      --text: #e8ebf5;
      --muted: #9aa3b2;
      --accent: #c7a45a;
      --accent-2: #6aa9ff;
      --danger: #ff7a7a;
      --radius: 16px;
      --shadow: 0 8px 30px rgba(0,0,0,.35);
    }
    * { box-sizing: border-box; }
    body {
      margin: 0; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      background: radial-gradient(1200px 800px at 10% -10%, #1c1f2b 0%, transparent 60%),
                  radial-gradient(1000px 700px at 110% 0%, #151a2d 0%, transparent 60%),
                  var(--bg);
      color: var(--text); height: 100vh; display: flex; flex-direction: column;
    }
    header {
      position: sticky; top: 0; z-index: 10; padding: 12px 14px;
      background: rgba(11,12,16,.8); backdrop-filter: blur(8px);
      border-bottom: 1px solid rgba(255,255,255,.06);
      display: flex; align-items: center; gap: 10px;
    }
    .logo { font-weight: 800; letter-spacing: .4px; padding: 8px 10px;
      border: 1px solid rgba(199,164,90,.45); border-radius: 999px;
      background: linear-gradient(180deg, rgba(199,164,90,.16), transparent);
      color: #f6e6bf; white-space: nowrap;
    }
    .spacer { flex: 1; }
    .controls { display: flex; gap: 8px; align-items: center; flex-wrap: wrap;}
    select, button, input { font-family: inherit; color: var(--text); }
    select { background: var(--panel); border: 1px solid rgba(255,255,255,.08);
      border-radius: 10px; padding: 7px 9px; outline: none;
    }
    button {
      background: linear-gradient(180deg, #1b1f2b, #121524);
      border: 1px solid rgba(255,255,255,.1);
      border-radius: 12px; padding: 8px 11px; cursor: pointer; box-shadow: var(--shadow);
      transition: transform .06s ease, border-color .2s ease;
    }
    button:hover { transform: translateY(-1px); border-color: rgba(199,164,90,.6); }
    button.primary { background: linear-gradient(180deg, rgba(199,164,90,.25), rgba(199,164,90,.08));
      border-color: rgba(199,164,90,.7); color: #ffeec7; }
    button.ghost { box-shadow: none; background: transparent; }
    button.danger { border-color: rgba(255,122,122,.6); color: #ffd3d3; }
    main { padding: 12px; overflow: auto; flex: 1; }

    .board { display: grid; grid-template-columns: repeat(4, minmax(260px, 1fr)); gap: 12px; align-items: start; }
    @media (max-width: 1100px) { .board { grid-template-columns: repeat(2, minmax(260px, 1fr)); } }
    @media (max-width: 640px) { .board { grid-template-columns: 1fr; } }

    .col { background: var(--panel); border: 1px solid rgba(255,255,255,.06);
      border-radius: var(--radius); box-shadow: var(--shadow); overflow: hidden; }
    .col-header { display: flex; align-items: center; gap: 8px; padding: 12px;
      background: var(--panel-2); border-bottom: 1px solid rgba(255,255,255,.06); }
    .col-title { font-weight: 700; }
    .col-count { margin-left: auto; font-size: 12px; color: var(--muted);
      background: rgba(255,255,255,.06); padding: 2px 8px; border-radius: 999px; }

    .dropzone { min-height: 120px; padding: 10px; display: flex; flex-direction: column; gap: 8px; }
    .dropzone.dragover { outline: 2px dashed rgba(106,169,255,.7); outline-offset: -6px; background: rgba(106,169,255,.06); }

    .card { background: #0f1320; border: 1px solid rgba(255,255,255,.08); border-radius: 14px;
      padding: 10px; display: grid; gap: 8px; cursor: grab; }
    .card:active { cursor: grabbing; }
    .card-title { font-weight: 600; line-height: 1.35; }
    .card-meta { font-size: 12px; color: var(--muted); display:flex; gap:8px; flex-wrap: wrap; }
    .pill { font-size: 11px; padding: 2px 7px; border-radius: 999px;
      background: rgba(199,164,90,.12); border: 1px solid rgba(199,164,90,.35); color: #f6e6bf; }
    .pill.blue { background: rgba(106,169,255,.12); border-color: rgba(106,169,255,.45); color: #cfe1ff; }
    .pill.gray { background: rgba(255,255,255,.08); border-color: rgba(255,255,255,.12); color: #d6d9e4; }

    .card-actions { display:flex; gap:6px; }
    .card-actions button { padding: 6px 8px; font-size: 12px; border-radius: 10px; }

    .hint { font-size: 12px; color: var(--muted); padding: 6px 10px; }

    /* notification drawer */
    .notif-wrap { position: relative; }
    .notif-btn { position: relative; }
    .notif-dot {
      position:absolute; top:-2px; right:-2px; width:10px; height:10px; border-radius:50%;
      background:#ff5d5d; display:none;
    }
    .drawer {
      position: absolute; right:0; top: 44px; width: min(380px, 92vw);
      background: var(--panel); border:1px solid rgba(255,255,255,.08);
      border-radius: 14px; box-shadow: var(--shadow);
      padding: 8px; display:none; z-index:20;
    }
    .notif-item {
      padding:8px; border-radius:10px; display:flex; gap:8px; align-items:flex-start;
      border:1px solid rgba(255,255,255,.05); background:#0e121d;
      margin-bottom:6px;
    }
    .notif-item:last-child { margin-bottom:0; }
    .notif-title { font-weight:600; font-size:14px; }
    .notif-meta { font-size:12px; color:var(--muted); }

    /* modal */
    .modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,.55);
      display: none; align-items: center; justify-content: center; padding: 16px; }
    .modal { width: min(520px, 100%); background: var(--panel);
      border: 1px solid rgba(255,255,255,.08); border-radius: 18px; box-shadow: var(--shadow); padding: 14px; }
    .modal h3 { margin: 4px 0 10px; }
    .form { display: grid; gap: 10px; grid-template-columns: 1fr 1fr; }
    .form .full { grid-column: 1 / -1; }
    label { font-size: 12px; color: var(--muted); }
    input[type="text"], input[type="date"], textarea {
      width: 100%; background: #0e111a; border: 1px solid rgba(255,255,255,.1);
      border-radius: 10px; padding: 8px 9px; outline: none;
    }
    textarea { min-height: 80px; resize: vertical; }
    .modal-footer { display:flex; gap:8px; justify-content: flex-end; margin-top: 10px; }
  </style>
</head>
<body>
  <header>
    <div class="logo">JM Kanban</div>
    <div class="hint" id="subtitle">Team board</div>
    <div class="spacer"></div>
    <div class="controls">
      <div class="notif-wrap">
        <button class="ghost notif-btn" id="notifBtn">üîî</button>
        <span class="notif-dot" id="notifDot"></span>
        <div class="drawer" id="notifDrawer"></div>
      </div>
      <select id="lang">
        <option value="zh">‰∏≠Êñá</option>
        <option value="th">‡πÑ‡∏ó‡∏¢</option>
        <option value="en" selected>English</option>
        <option value="ru">–†—É—Å—Å–∫–∏–π</option>
      </select>
      <button class="primary" id="addBtn">+ Add task</button>
      <button class="ghost" id="refreshBtn">‚Üª Refresh</button>
    </div>
  </header>

  <main>
    <section class="board" id="board"></section>
  </main>

  <!-- Modal -->
  <div class="modal-backdrop" id="backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <h3 id="modalTitle">New Task</h3>
      <div class="form">
        <div class="full">
          <label id="lblTitle">Title</label>
          <input type="text" id="taskTitle" placeholder="e.g. Update S2-26 documents" />
        </div>
        <div>
          <label id="lblAssignee">Assignee (name)</label>
          <input type="text" id="taskAssignee" placeholder="e.g. Lita" />
        </div>
        <div>
          <label id="lblDue">Due date</label>
          <input type="date" id="taskDue" />
        </div>
        <div class="full">
          <label id="lblDesc">Description</label>
          <textarea id="taskDesc" placeholder="details..."></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="ghost" id="cancelBtn">Cancel</button>
        <button class="primary" id="saveBtn">Save</button>
      </div>
    </div>
  </div>

  <script>
  // ====== CONFIG: put your Web App URL here ======
  const API_BASE = "https://script.google.com/a/macros/cloverth.net/s/AKfycbzwN3vAslx4po-ysK0RA32LVF6rqoF9CIdoE1Z75kEN_jnfaHsABPn15NoyIYvnlc4l/exec"; // e.g. https://script.google.com/macros/s/XXXX/exec

  // -------------------- i18n --------------------
  const I18N = {
    zh: {
      subtitle: "Âõ¢ÈòüÁúãÊùøÔºàSheets ÂêéÂè∞Ôºâ",
      add: "+ Êñ∞Âª∫‰ªªÂä°",
      refresh: "Âà∑Êñ∞",
      newTask: "Êñ∞Âª∫‰ªªÂä°",
      editTask: "ÁºñËæë‰ªªÂä°",
      title: "Ê†áÈ¢ò",
      assignee: "Ë¥üË¥£‰∫∫ÔºàÂßìÂêçÔºâ",
      due: "Êà™Ê≠¢Êó•Êúü",
      desc: "Â§áÊ≥®",
      cancel: "ÂèñÊ∂à",
      save: "‰øùÂ≠ò",
      cols: ["ÂæÖÂ§ÑÁêÜ", "ËøõË°å‰∏≠", "ÂæÖÂÆ°Ê†∏", "Â∑≤ÂÆåÊàê"],
      addHint: "ÊãñÂä®Âç°ÁâáÂà∞Âà´ÁöÑÂàóÂç≥ÂèØÂèòÊõ¥Áä∂ÊÄÅ",
      delete: "Âà†Èô§",
      edit: "ÁºñËæë",
      noTitle: "ËØ∑Â°´ÂÜôÊ†áÈ¢ò",
      notifEmpty: "ÊöÇÊó†Êñ∞ÈÄöÁü•",
      notifNew: "Êñ∞‰ªªÂä°",
      notifReassign: "‰ªªÂä°ËΩ¨‰∫§",
      markRead: "Â∑≤ËØª"
    },
    th: {
      subtitle: "‡∏ö‡∏≠‡∏£‡πå‡∏î‡∏ó‡∏µ‡∏° (‡πÉ‡∏ä‡πâ Sheets ‡πÄ‡∏õ‡πá‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•)",
      add: "+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô",
      refresh: "‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä",
      newTask: "‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà",
      editTask: "‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏á‡∏≤‡∏ô",
      title: "‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á",
      assignee: "‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö (‡∏ä‡∏∑‡πà‡∏≠)",
      due: "‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡πà‡∏á",
      desc: "‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î",
      cancel: "‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å",
      save: "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å",
      cols: ["‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥", "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥", "‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö", "‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß"],
      addHint: "‡∏•‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÑ‡∏õ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏≠‡∏∑‡πà‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞",
      delete: "‡∏•‡∏ö",
      edit: "‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç",
      noTitle: "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á",
      notifEmpty: "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô",
      notifNew: "‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà",
      notifReassign: "‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢‡πÉ‡∏´‡∏°‡πà",
      markRead: "‡∏≠‡πà‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß"
    },
    en: {
      subtitle: "Team board (Sheets backend)",
      add: "+ Add task",
      refresh: "Refresh",
      newTask: "New Task",
      editTask: "Edit Task",
      title: "Title",
      assignee: "Assignee (name)",
      due: "Due date",
      desc: "Description",
      cancel: "Cancel",
      save: "Save",
      cols: ["To Do", "Doing", "Review", "Done"],
      addHint: "Drag cards to another column to change status",
      delete: "Delete",
      edit: "Edit",
      noTitle: "Please enter a title",
      notifEmpty: "No new notifications",
      notifNew: "New task",
      notifReassign: "Reassigned",
      markRead: "Mark read"
    },
    ru: {
      subtitle: "–ö–æ–º–∞–Ω–¥–Ω–∞—è –¥–æ—Å–∫–∞ (Sheets backend)",
      add: "+ –î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É",
      refresh: "–û–±–Ω–æ–≤–∏—Ç—å",
      newTask: "–ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞",
      editTask: "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å",
      title: "–ó–∞–≥–æ–ª–æ–≤–æ–∫",
      assignee: "–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π (–∏–º—è)",
      due: "–°—Ä–æ–∫",
      desc: "–û–ø–∏—Å–∞–Ω–∏–µ",
      cancel: "–û—Ç–º–µ–Ω–∞",
      save: "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å",
      cols: ["–°–¥–µ–ª–∞—Ç—å", "–í —Ä–∞–±–æ—Ç–µ", "–ü—Ä–æ–≤–µ—Ä–∫–∞", "–ì–æ—Ç–æ–≤–æ"],
      addHint: "–ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–π—Ç–µ –∫–∞—Ä—Ç–æ—á–∫–∏ –º–µ–∂–¥—É –∫–æ–ª–æ–Ω–∫–∞–º–∏",
      delete: "–£–¥–∞–ª–∏—Ç—å",
      edit: "–ò–∑–º–µ–Ω–∏—Ç—å",
      noTitle: "–í–≤–µ–¥–∏—Ç–µ –∑–∞–≥–æ–ª–æ–≤–æ–∫",
      notifEmpty: "–ù–µ—Ç –Ω–æ–≤—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π",
      notifNew: "–ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞",
      notifReassign: "–ü–µ—Ä–µ–Ω–∞–∑–Ω–∞—á–µ–Ω–æ",
      markRead: "–ü—Ä–æ—á–∏—Ç–∞–Ω–æ"
    }
  };

  // -------------------- state --------------------
  let state = {
    lang: "en",
    columns: [
      { id: "todo", cards: [] },
      { id: "doing", cards: [] },
      { id: "review", cards: [] },
      { id: "done", cards: [] },
    ],
    notifications: []
  };

  // -------------------- helpers --------------------
  const boardEl = document.getElementById("board");
  const langEl = document.getElementById("lang");
  const subtitleEl = document.getElementById("subtitle");
  const notifBtn = document.getElementById("notifBtn");
  const notifDot = document.getElementById("notifDot");
  const notifDrawer = document.getElementById("notifDrawer");

  function t() { return I18N[state.lang]; }

  async function apiGet(action, params={}) {
    const url = new URL(API_BASE);
    url.searchParams.set("action", action);
    Object.entries(params).forEach(([k,v])=> url.searchParams.set(k,v));
    const res = await fetch(url.toString(), { method:"GET" });
    return res.json();
  }

  async function apiPost(action, body={}) {
    const url = new URL(API_BASE);
    url.searchParams.set("action", action);
    const res = await fetch(url.toString(), {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify(body)
    });
    return res.json();
  }

  function groupTasks(tasks){
    const cols = { todo:[], doing:[], review:[], done:[] };
    tasks.forEach(task => {
      const s = (task.status||"todo").toLowerCase();
      if (!cols[s]) cols.todo.push(task);
      else cols[s].push(task);
    });
    state.columns.forEach(c => c.cards = cols[c.id] || []);
  }

  // -------------------- render --------------------
  function render() {
    langEl.value = state.lang;
    subtitleEl.textContent = t().subtitle;
    document.getElementById("addBtn").textContent = t().add;
    document.getElementById("refreshBtn").textContent = "‚Üª " + t().refresh;

    boardEl.innerHTML = "";
    state.columns.forEach((col, idx) => {
      const colEl = document.createElement("div");
      colEl.className = "col";
      colEl.dataset.colId = col.id;

      const header = document.createElement("div");
      header.className = "col-header";
      header.innerHTML = `
        <div class="col-title">${t().cols[idx]}</div>
        <div class="col-count">${col.cards.length}</div>
      `;
      colEl.appendChild(header);

      const zone = document.createElement("div");
      zone.className = "dropzone";
      zone.dataset.colId = col.id;
      zone.addEventListener("dragover", onDragOver);
      zone.addEventListener("dragleave", onDragLeave);
      zone.addEventListener("drop", onDrop);

      col.cards
        .sort((a,b)=> new Date(a.createdAt) - new Date(b.createdAt))
        .forEach(card => zone.appendChild(renderCard(card, col.id)));

      const hint = document.createElement("div");
      hint.className = "hint";
      hint.textContent = t().addHint;
      zone.appendChild(hint);

      colEl.appendChild(zone);
      boardEl.appendChild(colEl);
    });

    renderNotifications();
  }

  function renderCard(card, colId){
    const el = document.createElement("div");
    el.className = "card";
    el.draggable = true;
    el.dataset.cardId = card.id;
    el.dataset.fromCol = colId;
    el.addEventListener("dragstart", onDragStart);

    const dueText = card.dueDate ? new Date(card.dueDate).toLocaleDateString() : "‚Äî";
    el.innerHTML = `
      <div class="card-title"></div>
      <div class="card-meta">
        <span class="pill">${card.assigneeName || "Unassigned"}</span>
        <span class="pill blue">${dueText}</span>
        <span class="pill gray">${(card.createdBy||"").split("@")[0] || ""}</span>
      </div>
      ${card.description ? `<div style="font-size:13px;color:#cbd3e1;line-height:1.4">${escapeHtml(card.description)}</div>` : ""}
      <div class="card-actions">
        <button class="ghost" data-action="edit">${t().edit}</button>
        <button class="ghost danger" data-action="delete">${t().delete}</button>
      </div>
    `;
    el.querySelector(".card-title").textContent = card.title;

    el.addEventListener("click", (e)=>{
      const btn = e.target.closest("button");
      if (!btn) return;
      const action = btn.dataset.action;
      if (action==="delete") deleteCard(card.id);
      if (action==="edit") openModal(card);
    });

    return el;
  }

  function escapeHtml(s){
    return s.replace(/[&<>\"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;',\"'\":'&#39;'}[m]));
  }

  // -------------------- drag --------------------
  let dragged=null;
  function onDragStart(e){
    dragged = { cardId: e.currentTarget.dataset.cardId, fromCol: e.currentTarget.dataset.fromCol };
    e.dataTransfer.effectAllowed="move";
  }
  function onDragOver(e){ e.preventDefault(); e.currentTarget.classList.add("dragover"); }
  function onDragLeave(e){ e.currentTarget.classList.remove("dragover"); }
  async function onDrop(e){
    e.preventDefault();
    e.currentTarget.classList.remove("dragover");
    if (!dragged) return;
    const toCol = e.currentTarget.dataset.colId;
    if (toCol !== dragged.fromCol){
      await apiPost("updateTask", { id: dragged.cardId, patch: { status: toCol }});
      await refreshAll();
    }
    dragged=null;
  }

  // -------------------- CRUD --------------------
  async function refreshAll(){
    const tasksRes = await apiGet("listTasks");
    if (tasksRes.ok) groupTasks(tasksRes.data);
    else alert(tasksRes.error||"listTasks failed");

    const email = await getUserEmailBestEffort();
    const notRes = await apiGet("listNotifications", { email });
    if (notRes.ok) state.notifications = notRes.data;
    render();
  }

  async function createCard(payload){
    const createdBy = await getUserEmailBestEffort();
    const res = await apiPost("createTask", { ...payload, createdBy });
    if (!res.ok) alert(res.error||"createTask failed");
    await refreshAll();
  }

  async function deleteCard(id){
    // simplest: set status done + title prefix. (real delete can be added)
    await apiPost("updateTask", { id, patch: { status:"done", title:"[DEL] " + findTask(id)?.title }});
    await refreshAll();
  }

  function findTask(id){
    for (const c of state.columns){
      const t = c.cards.find(x=>x.id===id);
      if (t) return t;
    }
    return null;
  }

  // -------------------- notifications --------------------
  function renderNotifications(){
    const unread = state.notifications.filter(n=> n.state==="UNREAD");
    notifDot.style.display = unread.length ? "block" : "none";
    notifDrawer.innerHTML = "";

    if (!state.notifications.length){
      notifDrawer.innerHTML = `<div class="hint">${t().notifEmpty}</div>`;
      return;
    }

    state.notifications
      .sort((a,b)=> new Date(b.createdAt)-new Date(a.createdAt))
      .slice(0, 20)
      .forEach(n=>{
        const task = findTask(n.taskId) || {};
        const typeLabel = n.type==="REASSIGNED" ? t().notifReassign : t().notifNew;
        const item = document.createElement("div");
        item.className="notif-item";
        item.innerHTML = `
          <div>
            <div class="notif-title">${typeLabel}: ${escapeHtml(task.title||n.taskId)}</div>
            <div class="notif-meta">${task.assigneeName||""} ‚Ä¢ ${task.dueDate||"‚Äî"} ‚Ä¢ ${new Date(n.createdAt).toLocaleString()}</div>
          </div>
          <div style="margin-left:auto">
            <button class="ghost" data-id="${n.id}">${t().markRead}</button>
          </div>
        `;
        item.querySelector("button").addEventListener("click", async ()=>{
          await apiPost("deleteNotification", { id: n.id });
          await refreshAll();
        });
        notifDrawer.appendChild(item);
      });
  }

  notifBtn.addEventListener("click", ()=>{
    notifDrawer.style.display = notifDrawer.style.display==="block" ? "none" : "block";
  });
  document.addEventListener("click", (e)=>{
    if (!e.target.closest(".notif-wrap")) notifDrawer.style.display="none";
  });

  // -------------------- modal --------------------
  const backdrop = document.getElementById("backdrop");
  const modalTitle = document.getElementById("modalTitle");
  const taskTitle = document.getElementById("taskTitle");
  const taskAssignee = document.getElementById("taskAssignee");
  const taskDue = document.getElementById("taskDue");
  const taskDesc = document.getElementById("taskDesc");
  const lblTitle = document.getElementById("lblTitle");
  const lblAssignee = document.getElementById("lblAssignee");
  const lblDue = document.getElementById("lblDue");
  const lblDesc = document.getElementById("lblDesc");
  const cancelBtn = document.getElementById("cancelBtn");
  const saveBtn = document.getElementById("saveBtn");

  let editingId=null;
  function openModal(card=null){
    editingId = card?.id || null;
    modalTitle.textContent = editingId ? t().editTask : t().newTask;
    lblTitle.textContent = t().title;
    lblAssignee.textContent = t().assignee;
    lblDue.textContent = t().due;
    lblDesc.textContent = t().desc;
    cancelBtn.textContent = t().cancel;
    saveBtn.textContent = t().save;

    taskTitle.value = card?.title || "";
    taskAssignee.value = card?.assigneeName || "";
    taskDue.value = card?.dueDate || "";
    taskDesc.value = card?.description || "";

    backdrop.style.display="flex";
    taskTitle.focus();
  }
  function closeModal(){ backdrop.style.display="none"; editingId=null; }

  cancelBtn.addEventListener("click", closeModal);
  backdrop.addEventListener("click", (e)=>{ if (e.target===backdrop) closeModal(); });

  saveBtn.addEventListener("click", async ()=>{
    const title = taskTitle.value.trim();
    if (!title) { alert(t().noTitle); return; }
    const assigneeName = taskAssignee.value.trim();
    const dueDate = taskDue.value;
    const description = taskDesc.value.trim();

    if (editingId){
      await apiPost("updateTask", { id: editingId, patch: { title, assigneeName, dueDate, description }});
      await refreshAll();
    } else {
      await createCard({ title, assigneeName, dueDate, description, status:"todo" });
    }
    closeModal();
  });

  // -------------------- auth best effort --------------------
  async function getUserEmailBestEffort(){
    // In Workspace, many browsers expose email via Google identity only if using auth.
    // As a fallback, ask once and store locally.
    const key="jm_user_email";
    let em = localStorage.getItem(key);
    if (em) return em;
    em = prompt("Your work email (used for notifications):", "");
    if (em) localStorage.setItem(key, em.trim().toLowerCase());
    return (em||"").trim().toLowerCase();
  }

  // -------------------- init --------------------
  document.getElementById("addBtn").addEventListener("click", ()=>openModal());
  document.getElementById("refreshBtn").addEventListener("click", refreshAll);
  langEl.addEventListener("change", ()=>{ state.lang=langEl.value; render(); });

  // auto refresh every 30s
  refreshAll();
  setInterval(refreshAll, 30000);
  </script>
</body>
</html>
