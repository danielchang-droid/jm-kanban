<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>JM Kanban ‚Äî Team</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0b0c10; --panel:#11131a; --panel2:#151824;
      --text:#e8ebf5; --muted:#9aa3b2; --accent:#7c5cff; --accent2:#5637ff;
      --border:rgba(255,255,255,.06);
      --radius:16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:Inter,system-ui,sans-serif; color:var(--text); background:
        radial-gradient(1200px 800px at 10% -10%, #1c1f2b 0%, transparent 60%),
        radial-gradient(1000px 700px at 110% 0%, #151a2d 0%, transparent 60%),
        var(--bg);
      height:100vh; display:flex; flex-direction:column;
    }
    header{
      display:flex; align-items:center; justify-content:space-between;
      padding:14px 18px; border-bottom:1px solid var(--border);
    }
    .brand{display:flex; align-items:center; gap:10px; font-weight:700;}
    .brand-dot{width:10px;height:10px;border-radius:999px;background:var(--accent)}
    .toolbar{display:flex; align-items:center; gap:10px;}
    button{
      background:var(--panel2); color:var(--text); border:1px solid var(--border);
      padding:8px 12px; border-radius:12px; cursor:pointer; font-weight:600;
    }
    button:hover{border-color:rgba(255,255,255,.12)}
    .btn-accent{background:linear-gradient(180deg,var(--accent),var(--accent2)); border:0}
    select{
      background:var(--panel2); color:var(--text); border:1px solid var(--border);
      padding:7px 10px; border-radius:10px;
    }

    main{flex:1; padding:14px; display:grid; grid-template-columns:repeat(3,1fr); gap:12px;}
    .col{
      background:rgba(17,19,26,.7);
      border:1px solid var(--border); border-radius:var(--radius);
      padding:10px; display:flex; flex-direction:column; min-height:0;
    }
    .col-head{
      display:flex; align-items:center; justify-content:space-between;
      padding:8px 6px; font-weight:700; color:#d7dcf0;
    }
    .badge{font-size:12px;color:var(--muted); background:rgba(255,255,255,.06); padding:2px 8px; border-radius:999px;}
    .list{flex:1; overflow:auto; padding:4px; display:flex; flex-direction:column; gap:8px;}
    .empty{color:var(--muted); text-align:center; padding:24px 0; font-size:14px;}
    .card{
      background:var(--panel2); border:1px solid var(--border);
      border-radius:14px; padding:10px; display:flex; flex-direction:column; gap:6px;
      cursor:grab;
    }
    .title{font-weight:700}
    .meta{font-size:12px;color:var(--muted); display:flex; gap:8px; flex-wrap:wrap;}
    .pill{background:rgba(255,255,255,.06); padding:1px 6px; border-radius:999px;}

    /* Modal */
    .modal-backdrop{
      position:fixed; inset:0; background:rgba(0,0,0,.55); display:none; align-items:center; justify-content:center;
    }
    .modal{
      width:min(560px,92vw);
      background:var(--panel); border:1px solid var(--border);
      border-radius:18px; padding:14px; box-shadow:0 20px 80px rgba(0,0,0,.6);
    }
    .modal h3{margin:6px 4px 12px;}
    .grid{display:grid; grid-template-columns:1fr 1fr; gap:10px;}
    label{font-size:12px;color:var(--muted);}
    input, textarea{
      width:100%; background:var(--panel2); color:var(--text);
      border:1px solid var(--border); border-radius:10px; padding:8px 10px; margin-top:4px;
    }
    textarea{min-height:80px; resize:vertical;}
    .modal-actions{display:flex; justify-content:flex-end; gap:8px; margin-top:12px;}
    .danger{background:#a54b4b;border:0}
  </style>
</head>
<body>

<header>
  <div class="brand"><span class="brand-dot"></span>JM Kanban <span style="font-weight:400;color:var(--muted);font-size:13px;margin-left:6px">Team board</span></div>
  <div class="toolbar">
    <select id="langSel">
      <option value="en">English</option>
      <option value="zh">‰∏≠ÊñáÔºàÁÆÄ‰ΩìÔºâ</option>
      <option value="th">‡πÑ‡∏ó‡∏¢</option>
      <option value="ru">–†—É—Å—Å–∫–∏–π</option>
    </select>
    <button class="btn-accent" id="addBtn">+ Add task</button>
    <button id="refreshBtn">‚ü≥ Refresh</button>
  </div>
</header>

<main>
  <section class="col" data-status="todo">
    <div class="col-head">To Do <span class="badge" id="count-todo">0</span></div>
    <div class="list" id="list-todo"><div class="empty">No tasks</div></div>
  </section>
  <section class="col" data-status="doing">
    <div class="col-head">Doing <span class="badge" id="count-doing">0</span></div>
    <div class="list" id="list-doing"><div class="empty">No tasks</div></div>
  </section>
  <section class="col" data-status="done">
    <div class="col-head">Done <span class="badge" id="count-done">0</span></div>
    <div class="list" id="list-done"><div class="empty">No tasks</div></div>
  </section>
</main>

<!-- Modal -->
<div class="modal-backdrop" id="backdrop">
  <div class="modal" role="dialog" aria-modal="true">
    <h3>Create task</h3>
    <div class="grid">
      <div>
        <label>Title</label>
        <input id="mTitle" placeholder="e.g. Follow up client A2-..." />
      </div>
      <div>
        <label>Assignee (Name)</label>
        <input id="mAssignee" placeholder="e.g. Lita" />
      </div>
      <div>
        <label>Due date</label>
        <input id="mDue" type="date" />
      </div>
      <div>
        <label>Status</label>
        <select id="mStatus">
          <option>To Do</option>
          <option>Doing</option>
          <option>Done</option>
        </select>
      </div>
      <div style="grid-column:1/-1">
        <label>Description</label>
        <textarea id="mDesc" placeholder="Details..."></textarea>
      </div>
    </div>
    <div class="modal-actions">
      <button id="cancelBtn">Cancel</button>
      <button class="btn-accent" id="saveBtn">Save</button>
    </div>
  </div>
</div>

<script>
/** ====== CONFIG ====== **/
const API_BASE = "https://script.google.com/macros/s/AKfycbw5DMgrN-uG_FzPyn83P8SIg9E37BLipNTwnC5mEy2RyS_CIPTj_3XiOE-y5TahZDKP/exec";

/** ====== STATE ====== **/
let tasks = [];
let currentUserEmail = localStorage.getItem("jm_user_email") || "";

/** ====== HELPERS ====== **/
const $ = sel => document.querySelector(sel);

function normalizeStatus(s){
  const t = String(s||"").trim().toLowerCase().replace(/\s|-/g,"");
  if(t==="todo" || t==="tod0") return "todo";
  if(t==="doing") return "doing";
  if(t==="done") return "done";
  // fallback
  return "todo";
}

function fmtDate(d){
  if(!d) return "";
  try{
    return String(d).slice(0,10);
  }catch(e){ return d; }
}

/** ====== API: JSONP then fallback Fetch ====== **/
function jsonp(action){
  return new Promise((resolve,reject)=>{
    const cb = "cb_"+Math.random().toString(36).slice(2);
    const url = `${API_BASE}?action=${encodeURIComponent(action)}&callback=${cb}`;
    const script = document.createElement("script");
    const timeout = setTimeout(()=>{ cleanup(); reject(new Error("JSONP timeout")); }, 10000);
    function cleanup(){
      clearTimeout(timeout);
      delete window[cb];
      script.remove();
    }
    window[cb] = (res)=>{ cleanup(); resolve(res); };
    script.onerror = ()=>{ cleanup(); reject(new Error("JSONP load error")); };
    script.src = url;
    document.body.appendChild(script);
  });
}

async function get(action){
  try{
    const res = await jsonp(action);
    if(res && res.ok) return res.data;
    throw new Error(res?.error || "Bad JSONP response");
  }catch(e){
    // fallback to fetch JSON
    const r = await fetch(`${API_BASE}?action=${encodeURIComponent(action)}`);
    const j = await r.json();
    if(j.ok) return j.data;
    throw new Error(j.error || "Fetch fail");
  }
}

async function post(payload){
  const r = await fetch(API_BASE, {
    method:"POST",
    body: JSON.stringify(payload),
    headers:{ "Content-Type":"application/json" }
  });
  const j = await r.json();
  if(!j.ok) throw new Error(j.error || "POST fail");
  return j.data;
}

/** ====== RENDER ====== **/
function render(){
  const buckets = { todo:[], doing:[], done:[] };
  tasks.forEach(t=>{
    buckets[ normalizeStatus(t.status) ].push(t);
  });

  ["todo","doing","done"].forEach(k=>{
    const list = $("#list-"+k);
    list.innerHTML = "";
    const arr = buckets[k];
    $("#count-"+k).textContent = arr.length;

    if(!arr.length){
      const div = document.createElement("div");
      div.className="empty"; div.textContent="No tasks";
      list.appendChild(div);
      return;
    }

    arr.forEach(t=>{
      const card = document.createElement("div");
      card.className="card";
      card.draggable=true;
      card.dataset.id = t.id;

      card.innerHTML = `
        <div class="title">${t.title||"(no title)"}</div>
        <div style="font-size:13px;color:#c8cde0">${t.description||""}</div>
        <div class="meta">
          ${t.assigneeName?`<span class="pill">üë§ ${t.assigneeName}</span>`:""}
          ${t.dueDate?`<span class="pill">üìÖ ${fmtDate(t.dueDate)}</span>`:""}
        </div>
      `;

      // drag
      card.addEventListener("dragstart", ev=>{
        ev.dataTransfer.setData("text/plain", t.id);
      });

      list.appendChild(card);
    });
  });
}

/** ====== LOAD ====== **/
async function loadAll(){
  tasks = await get("listTasks");
  render();
}

/** ====== MODAL ====== **/
function openModal(){
  $("#backdrop").style.display="flex";
}
function closeModal(){
  $("#backdrop").style.display="none";
  $("#mTitle").value="";
  $("#mDesc").value="";
  $("#mAssignee").value="";
  $("#mDue").value="";
  $("#mStatus").value="To Do";
}

$("#addBtn").onclick=openModal;
$("#cancelBtn").onclick=closeModal;
$("#backdrop").addEventListener("click", e=>{
  if(e.target.id==="backdrop") closeModal();
});

$("#saveBtn").onclick = async ()=>{
  const title = $("#mTitle").value.trim();
  if(!title){ alert("Title is required"); return; }

  const payload = {
    action:"addTask",
    title,
    description: $("#mDesc").value.trim(),
    assigneeName: $("#mAssignee").value.trim(),
    dueDate: $("#mDue").value,
    status: $("#mStatus").value,
    createdBy: currentUserEmail
  };

  try{
    await post(payload);
    closeModal();
    await loadAll();
  }catch(err){
    alert("Save failed: "+err.message);
  }
};

$("#refreshBtn").onclick = ()=>loadAll().catch(e=>alert(e.message));

/** ====== DROP ZONES ====== **/
document.querySelectorAll(".col").forEach(col=>{
  col.addEventListener("dragover", ev=>ev.preventDefault());
  col.addEventListener("drop", async ev=>{
    ev.preventDefault();
    const id = ev.dataTransfer.getData("text/plain");
    const st = col.dataset.status; // todo / doing / done
    const statusLabel = st==="todo"?"To Do":st==="doing"?"Doing":"Done";
    try{
      await post({action:"moveTask", id, status: statusLabel});
      await loadAll();
    }catch(e){ alert(e.message); }
  });
});

/** ====== INIT ====== **/
(async function init(){
  if(!currentUserEmail){
    currentUserEmail = prompt("Enter your company email (for notifications):")?.trim().toLowerCase() || "";
    if(currentUserEmail) localStorage.setItem("jm_user_email", currentUserEmail);
  }
  try{
    await loadAll();
  }catch(err){
    console.error(err);
    alert("Init error: "+err.message);
  }
})();
</script>

</body>
</html>
