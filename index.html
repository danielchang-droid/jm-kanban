<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>JM Kanban – Team</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#0b0c10;
      --panel:#11131a;
      --panel-2:#151824;
      --text:#e8ebf5;
      --muted:#9aa3b2;
      --accent:#7c5cff;
      --accent-2:#9a86ff;
      --ok:#1fbf75;
      --warn:#ffb020;
      --danger:#ff5a5a;
      --line:rgba(255,255,255,0.06);
      --radius:18px;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family:Inter,system-ui,Segoe UI,Roboto,sans-serif;
      background:
        radial-gradient(1200px 800px at 10% -10%, #1c1f2b 0%, transparent 60%),
        radial-gradient(1000px 700px at 110% 0%, #151a2d 0%, transparent 60%),
        var(--bg);
      color:var(--text);
      height:100vh;
      display:flex;
      flex-direction:column;
    }
    header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:14px 16px;
      border-bottom:1px solid var(--line);
      background:rgba(10,10,14,0.6);
      backdrop-filter: blur(12px);
    }
    .brand{
      display:flex;align-items:center;gap:10px;font-weight:700;letter-spacing:.4px;
      background:linear-gradient(90deg,#fff,#c8d0ff);
      -webkit-background-clip:text;background-clip:text;color:transparent;
    }
    .brand-dot{
      width:10px;height:10px;border-radius:999px;background:var(--accent);
      box-shadow:0 0 18px var(--accent);
    }
    .rightbar{
      display:flex;align-items:center;gap:10px;
    }
    .pill{
      background:var(--panel);
      border:1px solid var(--line);
      padding:6px 10px;border-radius:999px;font-size:12px;color:var(--muted);
    }
    button{
      background:var(--panel-2);
      border:1px solid var(--line);
      color:var(--text);
      padding:8px 12px;border-radius:10px;cursor:pointer;
      font-weight:600;
      transition:transform .05s ease, opacity .2s ease;
    }
    button:active{ transform:translateY(1px); }
    button.primary{
      background:linear-gradient(180deg,var(--accent),#5e43ff);
      border:none;color:white;
      box-shadow:0 8px 20px rgba(124,92,255,.35);
    }
    button.ghost{ background:transparent; }
    button:disabled{ opacity:.55; cursor:not-allowed; transform:none; }

    main{
      flex:1;display:grid;grid-template-columns:repeat(3,1fr);
      gap:12px;padding:12px;
      min-height:0;
    }
    .col{
      background:rgba(20,22,30,0.6);
      border:1px dashed var(--line);
      border-radius:var(--radius);
      display:flex;flex-direction:column;min-height:0;
    }
    .col-head{
      display:flex;align-items:center;justify-content:space-between;
      padding:12px 12px 8px;
      font-weight:700;color:#cfd6ea;
    }
    .count{
      background:rgba(255,255,255,0.06);
      padding:2px 8px;border-radius:999px;font-size:12px;
    }
    .cards{
      padding:8px;overflow:auto;display:flex;flex-direction:column;gap:8px;
      min-height:0;
    }
    .card{
      background:var(--panel);
      border:1px solid var(--line);
      border-radius:14px;padding:10px;
      box-shadow:0 10px 30px rgba(0,0,0,.35);
    }
    .card h4{ margin:0 0 6px 0; font-size:15px; }
    .desc{
      font-size:12px;color:var(--muted);white-space:pre-wrap;margin-bottom:8px;
      max-height:80px; /* ↑ 更明显，让员工知道有内容 */
      overflow:hidden;
    }
    .meta{
      display:flex;flex-wrap:wrap;gap:6px;margin-bottom:8px;
      font-size:11px;color:#c9d0e5;
    }
    .tag{
      padding:3px 7px;border-radius:999px;border:1px solid var(--line);
      background:rgba(255,255,255,0.04);
    }
    .tag.priority.Urgent{ border-color:rgba(255,90,90,.6); color:#ffb1b1; background:rgba(255,90,90,.08); }
    .tag.priority.Planned{ border-color:rgba(255,176,32,.6); color:#ffd69a; background:rgba(255,176,32,.08); }
    .tag.priority.Normal{ border-color:rgba(124,92,255,.6); color:#d6ccff; background:rgba(124,92,255,.08); }

    .card-actions{
      display:flex;align-items:center;justify-content:space-between;gap:8px;
    }
    select{
      background:var(--panel-2);color:var(--text);border:1px solid var(--line);
      padding:6px;border-radius:8px;font-size:12px;
    }
    .links a{ color:#bfc8ff;font-size:12px; text-decoration:none; }
    .links a:hover{ text-decoration:underline; }

    /* modal */
    .backdrop{
      position:fixed;inset:0;background:rgba(0,0,0,.6);
      display:none;align-items:center;justify-content:center;z-index:50;
      padding:16px;
    }
    .modal{
      width:min(820px,100%);background:#0e1016;border:1px solid var(--line);
      border-radius:18px;padding:16px;box-shadow:0 20px 60px rgba(0,0,0,.6);
      max-height:90vh;overflow:auto;
    }
    .modal h3{ margin:0 0 12px 0; }
    .grid{
      display:grid;grid-template-columns:1fr 1fr;gap:10px;
    }
    .field label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px;}
    .field input,.field textarea{
      width:100%;background:var(--panel);border:1px solid var(--line);color:var(--text);
      padding:8px;border-radius:10px;font-size:14px;
    }
    .field textarea{ min-height:90px;resize:vertical; }
    .modal-actions{
      display:flex;justify-content:flex-end;gap:8px;margin-top:12px;
    }
    .comment{
      border-top:1px dashed var(--line);padding-top:8px;margin-top:8px;
    }
    .comment .citem{
      padding:6px 0;border-bottom:1px dashed var(--line);
      font-size:13px;
    }
    .comment .cmeta{ font-size:11px;color:var(--muted); }
    .comment-box{ display:flex;gap:6px;margin-top:6px; }
    .comment-box input{ flex:1; }
    @media (max-width: 960px){
      main{ grid-template-columns:1fr; }
      .grid{ grid-template-columns:1fr; }
    }
  </style>
</head>
<body>

<header>
  <div class="brand"><span class="brand-dot"></span>JM Kanban <span style="font-weight:500;font-size:12px;color:#98a0b6">Team board</span></div>
  <div class="rightbar">
    <div id="userPill" class="pill">Not logged in</div>
    <button id="logoutBtn" class="ghost" style="display:none;">Logout</button>
    <button id="refreshBtn">Refresh</button>
    <button id="addBtn" class="primary">+ Add task</button>
  </div>
</header>

<main>
  <section class="col" data-status="To Do">
    <div class="col-head">To Do <span class="count" id="c_todo">0</span></div>
    <div class="cards" id="todoCards"></div>
  </section>
  <section class="col" data-status="Doing">
    <div class="col-head">Doing <span class="count" id="c_doing">0</span></div>
    <div class="cards" id="doingCards"></div>
  </section>
  <section class="col" data-status="Done">
    <div class="col-head">Done / Approved <span class="count" id="c_done">0</span></div>
    <div class="cards" id="doneCards"></div>
  </section>
</main>

<div class="backdrop" id="backdrop">
  <div class="modal" id="modal"></div>
</div>

<script>
/*************** CONFIG ***************/
const API_BASE = "https://script.google.com/macros/s/AKfycbw5DMgrN-uG_FzPyn83P8SIg9E37BLipNTwnC5mEy2RyS_CIPTj_3XiOE-y5TahZDKP/exec";

/*************** STATE ***************/
let actor = null;
let tasks = [];
let loadingTasks = false;

/*************** JSONP Helper ***************/
function jsonp(action, params = {}) {
  return new Promise((resolve, reject) => {
    const cb = "cb_" + Math.random().toString(36).slice(2);
    params.action = action;
    params.callback = cb;
    const qs = new URLSearchParams(params).toString();
    const url = API_BASE + "?" + qs;

    const script = document.createElement("script");

    window[cb] = (data) => {
      try { delete window[cb]; } catch {}
      script.remove();
      resolve(data);
    };

    script.src = url;
    script.onerror = () => {
      try { delete window[cb]; } catch {}
      script.remove();
      reject(new Error("JSONP load error"));
    };

    document.body.appendChild(script);
  });
}

/*************** LOGIN ***************/
async function ensureLogin(){
  let email = localStorage.getItem("jm_user_email") || "";
  if (!email){
    email = prompt("Please enter your company email (xxx@cloverth.net):")?.trim().toLowerCase() || "";
  }
  if (!email) throw new Error("No email");

  const res = await jsonp("login", { email });
  if (!res.ok) {
    localStorage.removeItem("jm_user_email");
    alert("Login failed: " + res.error);
    throw new Error(res.error);
  }

  actor = res;
  localStorage.setItem("jm_user_email", actor.email);
  document.getElementById("userPill").textContent = actor.email + (actor.admin ? " (admin)" : "");
  document.getElementById("logoutBtn").style.display = "";
}

/*************** LOAD TASKS ***************/
async function loadTasks(){
  if (!actor) return;
  if (loadingTasks) return; // 防止并发刷新
  loadingTasks = true;

  const refreshBtn = document.getElementById("refreshBtn");
  const oldText = refreshBtn.textContent;
  refreshBtn.disabled = true;
  refreshBtn.textContent = "Loading...";

  try{
    const res = await jsonp("listTasks", { email: actor.email });
    if (!res.ok) throw new Error(res.error);

    const list = res.tasks || [];
    // ✅ 前端去重（按 id）
    const map = new Map();
    list.forEach(t => {
      if (t && t.id) map.set(t.id, t);
    });
    tasks = [...map.values()];

    render();
  }finally{
    loadingTasks = false;
    refreshBtn.disabled = false;
    refreshBtn.textContent = oldText;
  }
}

/*************** RENDER ***************/
function render(){
  const todo = tasks.filter(t => t.status==="To Do");
  const doing = tasks.filter(t => t.status==="Doing");
  const done = tasks.filter(t => t.status==="Done" || t.status==="Approved");

  setCol("todoCards", todo);
  setCol("doingCards", doing);
  setCol("doneCards", done);

  document.getElementById("c_todo").textContent = todo.length;
  document.getElementById("c_doing").textContent = doing.length;
  document.getElementById("c_done").textContent = done.length;
}

function setCol(id, list){
  const el = document.getElementById(id);
  el.innerHTML = "";
  list.forEach(t => el.appendChild(cardEl(t)));
}

function cardEl(t){
  const card = document.createElement("div");
  card.className="card";
  card.draggable = true;
  card.dataset.id = t.id;

  card.innerHTML = `
    <h4>${escapeHtml(t.title||"(No title)")}</h4>
    <div class="desc">${escapeHtml(t.description||"")}</div>
    <div class="meta">
      <span class="tag">@${escapeHtml(t.assigneeName||t.assigneeEmail||"")}</span>
      <span class="tag priority ${t.priority}">${t.priority||"Normal"}</span>
      <span class="tag">Due: ${fmtDate(t.dueDate)}</span>
      <span class="tag">By: ${escapeHtml(t.creatorEmail||"")}</span>
    </div>
    <div class="links">
      ${t.link1 ? `<a target="_blank" href="${t.link1}">Link1</a> `:""}
      ${t.link2 ? `<a target="_blank" href="${t.link2}">Link2</a> `:""}
      ${t.link3 ? `<a target="_blank" href="${t.link3}">Link3</a> `:""}
    </div>
    <div class="card-actions">
      <div style="display:flex;gap:6px;align-items:center;">
        <select class="statusSel">
          ${["To Do","Doing","Done","Approved"].map(s=>`<option ${t.status===s?"selected":""}>${s}</option>`).join("")}
        </select>
        ${canEditTask(t) ? `<button class="ghost editBtn">Edit</button>`:""}
      </div>
      <div style="display:flex;gap:6px;">
        <button class="ghost detailBtn">Detail</button>
        ${canArchiveTask(t) ? `<button class="ghost archiveBtn">Archive</button>`:""}
      </div>
    </div>
  `;

  card.querySelector(".statusSel").addEventListener("change", async (e)=>{
    const newStatus = e.target.value;
    if (newStatus==="Approved" && !canApprove(t)) {
      alert("Only creator/admin can approve.");
      e.target.value = t.status;
      return;
    }
    if (newStatus==="Doing" && t.status==="Done" && canApprove(t)) {
      const reason = prompt("Reason to return to Doing?") || "";
      await jsonp("returnToDoing", { actorEmail: actor.email, id: t.id, reason });
    } else {
      await jsonp("moveTask", { actorEmail: actor.email, id: t.id, status: newStatus });
    }
    await loadTasks();
  });

  const editBtn = card.querySelector(".editBtn");
  if (editBtn) editBtn.addEventListener("click", ()=> openEdit(t));

  card.querySelector(".detailBtn").addEventListener("click", ()=> openDetail(t));

  const archiveBtn = card.querySelector(".archiveBtn");
  if (archiveBtn) archiveBtn.addEventListener("click", async ()=>{
    if (!confirm("Archive this task?")) return;
    await jsonp("archiveTask", { actorEmail: actor.email, id: t.id });
    await loadTasks();
  });

  card.addEventListener("dragstart", (ev)=>{
    ev.dataTransfer.setData("text/plain", t.id);
  });

  return card;
}

/*************** PERMISSIONS ***************/
function canEditTask(t){
  if (actor.admin) return true;
  const ae = (t.assigneeEmail||"").toLowerCase();
  const ce = (t.creatorEmail||"").toLowerCase();
  return actor.email===ae || actor.email===ce;
}
function canArchiveTask(t){
  if (actor.admin) return true;
  return actor.email === (t.creatorEmail||"").toLowerCase();
}
function canApprove(t){
  if (actor.admin) return true;
  return actor.email === (t.creatorEmail||"").toLowerCase();
}

/*************** MODALS ***************/
function openModal(html){
  const bd = document.getElementById("backdrop");
  const m = document.getElementById("modal");
  m.innerHTML = html;
  bd.style.display="flex";
}
function closeModal(){
  document.getElementById("backdrop").style.display="none";
}

async function openCreate(){
  openModal(renderTaskForm({mode:"create"}));
  bindForm({mode:"create"});
}

function openEdit(t){
  openModal(renderTaskForm({mode:"edit", task:t}));
  bindForm({mode:"edit", task:t});
}

async function openDetail(t){
  const cr = await jsonp("listComments",{taskId:t.id});
  const comments = cr.comments||[];

  openModal(`
    <h3>Task detail</h3>
    <div class="field"><label>Title</label><div>${escapeHtml(t.title||"")}</div></div>
    <div class="field"><label>Description</label><div style="white-space:pre-wrap">${escapeHtml(t.description||"")}</div></div>
    <div class="field"><label>Assignee</label><div>${escapeHtml(t.assigneeName||"")} (${escapeHtml(t.assigneeEmail||"")})</div></div>
    <div class="field"><label>Priority</label><div>${t.priority}</div></div>
    <div class="field"><label>Status</label><div>${t.status}</div></div>
    <div class="field"><label>Due date</label><div>${fmtDate(t.dueDate)}</div></div>
    <div class="field"><label>Links</label>
      <div class="links">
        ${t.link1?`<a target="_blank" href="${t.link1}">${t.link1}</a><br>`:""}
        ${t.link2?`<a target="_blank" href="${t.link2}">${t.link2}</a><br>`:""}
        ${t.link3?`<a target="_blank" href="${t.link3}">${t.link3}</a><br>`:""}
      </div>
    </div>

    <div class="comment">
      <h4 style="margin:0 0 6px 0;">Comments</h4>
      <div id="cList">
        ${comments.map(c=>`
          <div class="citem">
            <div>${escapeHtml(c.text||"")}</div>
            <div class="cmeta">${escapeHtml(c.authorEmail||"")} · ${fmtDateTime(c.createdAt)}</div>
          </div>
        `).join("") || `<div class="cmeta">No comments yet.</div>`}
      </div>
      <div class="comment-box">
        <input id="cInput" placeholder="Write a comment..."/>
        <button id="cSend" class="primary">Send</button>
      </div>
    </div>

    <div class="modal-actions">
      ${canApprove(t) && t.status==="Done" ? `<button id="approveBtn" class="primary">Approve</button>
      <button id="returnBtn">Return to Doing</button>`:""}
      <button onclick="closeModal()">Close</button>
    </div>
  `);

  document.getElementById("cSend").addEventListener("click", async ()=>{
    const text = document.getElementById("cInput").value.trim();
    if (!text) return;
    await jsonp("addComment",{actorEmail:actor.email, taskId:t.id, text});
    await openDetail(t);
  });

  const approveBtn = document.getElementById("approveBtn");
  if (approveBtn) approveBtn.addEventListener("click", async ()=>{
    await jsonp("approve",{actorEmail:actor.email, id:t.id});
    closeModal(); await loadTasks();
  });
  const returnBtn = document.getElementById("returnBtn");
  if (returnBtn) returnBtn.addEventListener("click", async ()=>{
    const reason = prompt("Reason to return to Doing?") || "";
    await jsonp("returnToDoing",{actorEmail:actor.email, id:t.id, reason});
    closeModal(); await loadTasks();
  });
}

function renderTaskForm({mode, task={}}){
  const t = task;
  return `
    <h3>${mode==="create"?"Create task":"Edit task"}</h3>
    <div class="grid">
      <div class="field">
        <label>Title</label>
        <input id="f_title" value="${escapeAttr(t.title||"")}" placeholder="e.g. Follow up client A2-"/>
      </div>
      <div class="field">
        <label>Assignee (name)</label>
        <input id="f_assigneeName" value="${escapeAttr(t.assigneeName||"")}" placeholder="e.g. Lita"/>
      </div>

      <div class="field">
        <label>Assignee (email)</label>
        <input id="f_assigneeEmail" value="${escapeAttr(t.assigneeEmail||"")}" placeholder="xxx@cloverth.net"/>
      </div>
      <div class="field">
        <label>Priority</label>
        <select id="f_priority">
          ${["Urgent","Planned","Normal"].map(p=>`<option ${t.priority===p?"selected":""}>${p}</option>`).join("")}
        </select>
      </div>

      <div class="field">
        <label>Due date (required)</label>
        <input id="f_dueDate" type="date" value="${t.dueDate?toInputDate(t.dueDate):""}"/>
      </div>
      <div class="field">
        <label>Status</label>
        <select id="f_status">
          ${["To Do","Doing","Done","Approved"].map(s=>`<option ${t.status===s?"selected":""}>${s}</option>`).join("")}
        </select>
      </div>
    </div>

    <div class="field" style="margin-top:8px;">
      <label>Description (visible to assignee + creator)</label>
      <textarea id="f_description" placeholder="Details...">${escapeHtml(t.description||"")}</textarea>
    </div>

    <div class="grid" style="margin-top:8px;">
      <div class="field">
        <label>Link 1</label>
        <input id="f_link1" value="${escapeAttr(t.link1||"")}"/>
      </div>
      <div class="field">
        <label>Link 2</label>
        <input id="f_link2" value="${escapeAttr(t.link2||"")}"/>
      </div>
      <div class="field">
        <label>Link 3</label>
        <input id="f_link3" value="${escapeAttr(t.link3||"")}"/>
      </div>
    </div>

    <div class="modal-actions">
      <button onclick="closeModal()">Cancel</button>
      <button id="saveBtn" class="primary">Save</button>
    </div>
  `;
}

function bindForm({mode, task={}}){
  const saveBtn = document.getElementById("saveBtn");
  let saving = false;

  saveBtn.addEventListener("click", async ()=>{
    if (saving) return;               // ✅ 防二次点击
    saving = true;
    saveBtn.disabled = true;
    const oldText = saveBtn.textContent;
    saveBtn.textContent = "Saving...";

    try{
      const title = document.getElementById("f_title").value.trim();
      const assigneeName = document.getElementById("f_assigneeName").value.trim();
      const assigneeEmail = document.getElementById("f_assigneeEmail").value.trim().toLowerCase();
      const priority = document.getElementById("f_priority").value;
      const status = document.getElementById("f_status").value;
      const dueDate = document.getElementById("f_dueDate").value;
      const description = document.getElementById("f_description").value.trim();
      const link1 = document.getElementById("f_link1").value.trim();
      const link2 = document.getElementById("f_link2").value.trim();
      const link3 = document.getElementById("f_link3").value.trim();

      if (!title) throw new Error("Title required");
      if (!assigneeEmail.endsWith("@cloverth.net")) throw new Error("Assignee must be cloverth email");
      if (!dueDate) throw new Error("Due date required");

      if (mode==="create"){
        const res = await jsonp("createTask", {
          actorEmail: actor.email,
          title, description, assigneeName, assigneeEmail,
          priority, status, dueDate,
          link1, link2, link3
        });
        if (!res.ok) throw new Error(res.error);
      } else {
        const res = await jsonp("updateTask", {
          actorEmail: actor.email,
          id: task.id,
          title, description, assigneeName, assigneeEmail,
          priority, status, dueDate,
          link1, link2, link3
        });
        if (!res.ok) throw new Error(res.error);
      }

      closeModal();
      await loadTasks();

    }catch(err){
      alert(err.message);
    }finally{
      saving = false;
      saveBtn.disabled = false;
      saveBtn.textContent = oldText;
    }
  });
}

/*************** DRAG DROP ***************/
document.querySelectorAll(".col").forEach(col=>{
  col.addEventListener("dragover", e=>e.preventDefault());
  col.addEventListener("drop", async e=>{
    e.preventDefault();
    const id = e.dataTransfer.getData("text/plain");
    const status = col.dataset.status;
    await jsonp("moveTask",{actorEmail:actor.email, id, status});
    await loadTasks();
  });
});

/*************** UTIL ***************/
function fmtDate(d){
  if (!d) return "-";
  try{ return new Date(d).toISOString().slice(0,10); }catch{ return d; }
}
function fmtDateTime(d){
  if (!d) return "-";
  try{ return new Date(d).toLocaleString(); }catch{ return d; }
}
function toInputDate(d){
  try{ return new Date(d).toISOString().slice(0,10); }catch{ return ""; }
}
function escapeHtml(s){
  s = String(s||"");
  return s.replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]));
}
function escapeAttr(s){ return escapeHtml(s).replace(/"/g,"&quot;"); }

/*************** INIT ***************/
(async function init(){
  try{
    await ensureLogin();
    await loadTasks();
  }catch(err){
    console.error(err);
    alert("Init error: " + err.message);
  }

  document.getElementById("addBtn").addEventListener("click", openCreate);
  document.getElementById("refreshBtn").addEventListener("click", loadTasks);

  document.getElementById("logoutBtn").addEventListener("click", ()=>{
    localStorage.removeItem("jm_user_email");
    location.reload();
  });

  // auto refresh every 60s (不会并发、不会重复显示)
  setInterval(loadTasks, 60000);
})();
</script>

</body>
</html>
