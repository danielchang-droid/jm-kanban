<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>JM Kanban ‚Äî Team</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#0b0c10;
      --panel:#11131a;
      --panel-2:#151824;
      --text:#e8ebf5;
      --muted:#9aa3b2;
      --line:#232737;
      --accent:#7c5cff;
      --accent-2:#4f46e5;
      --good:#10b981;
      --warn:#f59e0b;
      --bad:#ef4444;
      --radius:16px;
    }
    *{box-sizing:border-box;}
    body{
      margin:0;
      font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      background:
        radial-gradient(1200px 800px at 10% -10%, #1c1f2b 0%, transparent 60%),
        radial-gradient(1000px 700px at 110% 0%, #151a2d 0%, transparent 60%),
        var(--bg);
      color:var(--text);
      height:100vh;
      display:flex;
      flex-direction:column;
    }
    header{
      height:64px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:0 16px;
      border-bottom:1px solid var(--line);
      background:rgba(10,11,15,.6);
      backdrop-filter: blur(10px);
      position:sticky; top:0; z-index:10;
    }
    .brand{
      display:flex; align-items:center; gap:10px;
      font-weight:700; letter-spacing:.3px;
      padding:6px 10px; border-radius:999px;
      background:linear-gradient(90deg,#0f1117,#0b0c10);
      border:1px solid var(--line);
      box-shadow:0 6px 18px rgba(0,0,0,.35);
    }
    .brand-dot{
      width:10px;height:10px;border-radius:50%;
      background:var(--accent);
      box-shadow:0 0 14px var(--accent);
    }
    .right{
      display:flex; align-items:center; gap:8px;
    }
    select, button, input, textarea{
      font-family:inherit;
      color:var(--text);
    }
    .btn{
      height:36px; padding:0 12px;
      border-radius:10px; border:1px solid var(--line);
      background:var(--panel);
      cursor:pointer; font-weight:600;
      display:inline-flex; align-items:center; gap:6px;
      transition:.2s;
    }
    .btn:hover{ transform: translateY(-1px); border-color:#2c3146; }
    .btn.primary{
      background:linear-gradient(180deg,var(--accent),var(--accent-2));
      border:none;
      box-shadow:0 10px 18px rgba(124,92,255,.35);
    }
    .btn.ghost{
      background:transparent;
    }
    .pill{
      height:34px; padding:0 10px;
      border-radius:999px; border:1px solid var(--line);
      background:var(--panel);
      display:flex; align-items:center; gap:8px;
    }
    .pill select{
      background:transparent; border:none; outline:none;
      font-weight:600; cursor:pointer;
    }

    main{
      flex:1;
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:14px;
      padding:14px;
      min-height:0;
    }
    .col{
      background:rgba(17,19,26,.85);
      border:1px solid var(--line);
      border-radius:18px;
      display:flex; flex-direction:column;
      min-height:0;
      box-shadow:0 12px 30px rgba(0,0,0,.35);
    }
    .col-head{
      padding:12px 12px 8px;
      display:flex; align-items:center; justify-content:space-between;
      border-bottom:1px dashed var(--line);
    }
    .col-title{
      font-weight:700; font-size:15px;
      display:flex; align-items:center; gap:8px;
    }
    .badge{
      min-width:22px; height:22px; padding:0 6px;
      border-radius:999px; display:inline-flex;
      align-items:center; justify-content:center;
      font-size:12px; font-weight:700;
      background:var(--panel-2); border:1px solid var(--line);
      color:var(--muted);
    }
    .list{
      padding:10px;
      overflow:auto; flex:1; min-height:0;
      display:flex; flex-direction:column; gap:8px;
    }
    .card{
      background:var(--panel);
      border:1px solid var(--line);
      border-radius:14px;
      padding:10px;
      cursor:grab;
      transition:.15s;
    }
    .card:active{ cursor:grabbing; }
    .card:hover{ border-color:#2c3146; transform: translateY(-1px); }
    .card-title{
      font-weight:700; font-size:14px; margin-bottom:6px;
    }
    .card-desc{
      color:var(--muted); font-size:12.5px; line-height:1.4;
      white-space:pre-wrap;
    }
    .meta{
      margin-top:8px; display:flex; gap:6px; flex-wrap:wrap;
      font-size:12px; color:var(--muted);
    }
    .tag{
      background:var(--panel-2);
      border:1px solid var(--line);
      padding:2px 6px; border-radius:999px;
    }
    .meta .due{ color:#cbd5e1; }
    .meta .assignee{ color:#cbd5e1; }
    .meta .created{ color:var(--muted); }

    /* Modal */
    .backdrop{
      position:fixed; inset:0; background:rgba(0,0,0,.55);
      display:none; align-items:center; justify-content:center;
      z-index:100;
      padding:18px;
    }
    .modal{
      width:720px; max-width:100%;
      background:linear-gradient(180deg,#0f1117,#0b0c10);
      border:1px solid var(--line);
      border-radius:18px;
      padding:16px;
      box-shadow:0 20px 60px rgba(0,0,0,.6);
    }
    .modal-head{
      display:flex; align-items:center; justify-content:space-between;
      margin-bottom:10px;
    }
    .modal h3{ margin:0; font-size:18px; }
    .grid{
      display:grid; grid-template-columns:1fr 1fr; gap:12px;
    }
    label{
      font-size:12px; color:var(--muted); display:block; margin-bottom:6px;
    }
    input, textarea, select{
      width:100%;
      background:var(--panel);
      border:1px solid var(--line);
      border-radius:10px;
      padding:10px;
      outline:none;
      font-size:14px;
    }
    textarea{ min-height:90px; resize:vertical; }
    .modal-actions{
      display:flex; justify-content:flex-end; gap:8px; margin-top:12px;
    }

    .empty{
      color:var(--muted);
      font-size:13px;
      padding:8px;
      text-align:center;
      border:1px dashed var(--line);
      border-radius:12px;
      background:rgba(0,0,0,.2);
    }
  </style>
</head>
<body>

<header>
  <div class="brand">
    <span class="brand-dot"></span>
    <span>JM Kanban</span>
    <span style="color:var(--muted);font-weight:600;font-size:12px;">Team board</span>
  </div>

  <div class="right">
    <button class="btn ghost" id="bellBtn" title="Notifications">üîî</button>

    <div class="pill">
      <select id="langSel">
        <option value="en">English</option>
        <option value="zh">‰∏≠ÊñáÔºàÁÆÄ‰ΩìÔºâ</option>
        <option value="th">‡πÑ‡∏ó‡∏¢</option>
        <option value="ru">–†—É—Å—Å–∫–∏–π</option>
      </select>
    </div>

    <button class="btn primary" id="addBtn">+ Add task</button>
    <button class="btn" id="refreshBtn">‚ü≥ Refresh</button>
  </div>
</header>

<main>
  <section class="col" data-status="To Do">
    <div class="col-head">
      <div class="col-title">To Do <span class="badge" id="count-todo">0</span></div>
    </div>
    <div class="list" id="list-todo"></div>
  </section>

  <section class="col" data-status="Doing">
    <div class="col-head">
      <div class="col-title">Doing <span class="badge" id="count-doing">0</span></div>
    </div>
    <div class="list" id="list-doing"></div>
  </section>

  <section class="col" data-status="Done">
    <div class="col-head">
      <div class="col-title">Done <span class="badge" id="count-done">0</span></div>
    </div>
    <div class="list" id="list-done"></div>
  </section>
</main>

<!-- Create/Edit modal -->
<div class="backdrop" id="backdrop">
  <div class="modal">
    <div class="modal-head">
      <h3 id="modalTitle">Create task</h3>
      <button class="btn ghost" id="closeBtn">‚úï</button>
    </div>

    <div class="grid">
      <div>
        <label>Title</label>
        <input id="titleInput" placeholder="e.g. Follow up client A2-3"/>
      </div>

      <div>
        <label>Assignee (Name)</label>
        <input id="assigneeInput" placeholder="e.g. Lita"/>
      </div>

      <div>
        <label>Due date</label>
        <input id="dueInput" type="date"/>
      </div>

      <div>
        <label>Status</label>
        <select id="statusInput">
          <option>To Do</option>
          <option>Doing</option>
          <option>Done</option>
        </select>
      </div>

      <div style="grid-column:1 / -1;">
        <label>Description</label>
        <textarea id="descInput" placeholder="Details..."></textarea>
      </div>
    </div>

    <div class="modal-actions">
      <button class="btn" id="cancelBtn">Cancel</button>
      <button class="btn primary" id="saveBtn">Save</button>
    </div>
  </div>
</div>

<script>
/** ============================
 *  CONFIG
 *  ============================
 *  Put your latest Apps Script WebApp /exec here
 */
const API_BASE = "https://script.google.com/macros/s/AKfycbw5DMgrN-uG_FzPyn83P8SIg9E37BLipNTwnC5mEy2RyS_CIPTj_3XiOE-y5TahZDKP/exec";

/** ============================
 *  JSONP GET (avoid CORS)
 *  ============================
 */
function jsonp(action, params = {}) {
  return new Promise((resolve, reject) => {
    const cbName = "cb_" + Math.random().toString(36).slice(2);
    const query = new URLSearchParams({ action, callback: cbName, ...params });
    const url = `${API_BASE}?${query.toString()}`;

    window[cbName] = (resp) => {
      resolve(resp);
      cleanup();
    };

    const script = document.createElement("script");
    script.src = url;
    script.onerror = () => {
      reject(new Error("JSONP load error"));
      cleanup();
    };
    document.body.appendChild(script);

    function cleanup(){
      try { delete window[cbName]; } catch(e){}
      if(script.parentNode) script.parentNode.removeChild(script);
    }
  });
}

/** ============================
 *  POST no-cors (write)
 *  ============================
 */
function postNoCors(action, payload = {}) {
  return fetch(API_BASE, {
    method: "POST",
    mode: "no-cors",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ action, ...payload })
  });
}

/** ============================
 *  State
 *  ============================
 */
let tasks = [];
let notifications = [];
let currentUserEmail = "";
let editingTaskId = null;

/** ============================
 *  DOM
 *  ============================
 */
const listTodo = document.getElementById("list-todo");
const listDoing = document.getElementById("list-doing");
const listDone = document.getElementById("list-done");

const countTodo = document.getElementById("count-todo");
const countDoing = document.getElementById("count-doing");
const countDone = document.getElementById("count-done");

const backdrop = document.getElementById("backdrop");
const addBtn = document.getElementById("addBtn");
const refreshBtn = document.getElementById("refreshBtn");
const closeBtn = document.getElementById("closeBtn");
const cancelBtn = document.getElementById("cancelBtn");
const saveBtn = document.getElementById("saveBtn");

const modalTitle = document.getElementById("modalTitle");
const titleInput = document.getElementById("titleInput");
const assigneeInput = document.getElementById("assigneeInput");
const dueInput = document.getElementById("dueInput");
const statusInput = document.getElementById("statusInput");
const descInput = document.getElementById("descInput");

/** ============================
 *  Core
 *  ============================
 */
async function loadTasks(){
  const resp = await jsonp("listTasks");
  if(!resp.ok) throw new Error(resp.error || "listTasks failed");
  tasks = resp.data || [];
}
async function loadNotifs(){
  const resp = await jsonp("listNotifs");
  if(resp.ok) notifications = resp.data || [];
}

function renderBoard(){
  const byStatus = {
    "To Do": tasks.filter(t=>String(t.status||"To Do")==="To Do"),
    "Doing": tasks.filter(t=>String(t.status)==="Doing"),
    "Done": tasks.filter(t=>String(t.status)==="Done"),
  };

  // counts
  countTodo.textContent = byStatus["To Do"].length;
  countDoing.textContent = byStatus["Doing"].length;
  countDone.textContent = byStatus["Done"].length;

  // clear lists
  [listTodo,listDoing,listDone].forEach(l=>l.innerHTML="");

  function renderList(listEl, items){
    if(items.length===0){
      const empty = document.createElement("div");
      empty.className="empty";
      empty.textContent="No tasks";
      listEl.appendChild(empty);
      return;
    }

    items.forEach(t=>{
      const card = document.createElement("div");
      card.className="card";
      card.draggable = true;
      card.dataset.id = t.id;

      card.innerHTML = `
        <div class="card-title">${escapeHtml(t.title||"")}</div>
        <div class="card-desc">${escapeHtml(t.description||"")}</div>
        <div class="meta">
          ${t.assigneeName?`<span class="tag assignee">üë§ ${escapeHtml(t.assigneeName)}</span>`:""}
          ${t.dueDate?`<span class="tag due">üìÖ ${escapeHtml(t.dueDate)}</span>`:""}
          ${t.createdBy?`<span class="tag created">‚úçÔ∏è ${escapeHtml(t.createdBy)}</span>`:""}
        </div>
      `;

      // click = edit
      card.addEventListener("click", ()=>openEditModal(t));

      // drag events
      card.addEventListener("dragstart",(e)=>{
        e.dataTransfer.setData("text/plain", t.id);
      });

      listEl.appendChild(card);
    });
  }

  renderList(listTodo, byStatus["To Do"]);
  renderList(listDoing, byStatus["Doing"]);
  renderList(listDone, byStatus["Done"]);
}

function escapeHtml(s){
  return String(s||"")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#39;");
}

/** ============================
 *  Drag & drop columns
 *  ============================
 */
document.querySelectorAll(".col").forEach(col=>{
  col.addEventListener("dragover",(e)=>{ e.preventDefault(); });
  col.addEventListener("drop", async (e)=>{
    e.preventDefault();
    const id = e.dataTransfer.getData("text/plain");
    const toStatus = col.dataset.status;
    const task = tasks.find(x=>x.id===id);
    if(!task || task.status===toStatus) return;

    await postNoCors("moveTask", { id, status: toStatus });
    setTimeout(initRefresh, 800);
  });
});

/** ============================
 *  Modal
 *  ============================
 */
function openCreateModal(){
  editingTaskId = null;
  modalTitle.textContent="Create task";
  titleInput.value="";
  assigneeInput.value="";
  dueInput.value="";
  statusInput.value="To Do";
  descInput.value="";
  backdrop.style.display="flex";
}

function openEditModal(task){
  editingTaskId = task.id;
  modalTitle.textContent="Edit task";
  titleInput.value=task.title||"";
  assigneeInput.value=task.assigneeName||"";
  dueInput.value=task.dueDate||"";
  statusInput.value=task.status||"To Do";
  descInput.value=task.description||"";
  backdrop.style.display="flex";
}

function closeModal(){
  backdrop.style.display="none";
}

addBtn.addEventListener("click", openCreateModal);
closeBtn.addEventListener("click", closeModal);
cancelBtn.addEventListener("click", closeModal);

saveBtn.addEventListener("click", async ()=>{
  const title = titleInput.value.trim();
  const assigneeName = assigneeInput.value.trim();
  const dueDate = dueInput.value;
  const status = statusInput.value;
  const description = descInput.value.trim();

  if(!title){
    alert("Title is required");
    return;
  }

  if(editingTaskId){
    await postNoCors("updateTask", {
      id: editingTaskId,
      title,
      description,
      assigneeName,
      dueDate,
      status,
      createdBy: currentUserEmail
    });
  }else{
    await postNoCors("addTask", {
      title,
      description,
      assigneeName,
      dueDate,
      status,
      createdBy: currentUserEmail
    });
  }

  closeModal();
  setTimeout(initRefresh, 900);
});

/** ============================
 *  Refresh
 *  ============================
 */
async function initRefresh(){
  try{
    await loadTasks();
    await loadNotifs();
    renderBoard();
  }catch(err){
    console.error(err);
    alert("Init error: " + err.message + "\nCheck API_BASE is correct & Web App access is Anyone.");
  }
}
refreshBtn.addEventListener("click", initRefresh);

/** ============================
 *  Init
 *  ============================
 */
(async function init(){
  currentUserEmail = localStorage.getItem("jm_user_email") || "";
  if(!currentUserEmail){
    currentUserEmail = prompt("Please enter your company email (for notifications):")?.trim().toLowerCase() || "";
    if(currentUserEmail) localStorage.setItem("jm_user_email", currentUserEmail);
  }

  await initRefresh();

  // auto refresh every 30s
  setInterval(()=>{ initRefresh(); }, 30000);
})();
</script>
</body>
</html>
