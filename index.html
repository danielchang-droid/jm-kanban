<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>JM Kanban â€” Team</title>
  <style>
    :root{
      --bg:#0b0c10;--panel:#11131a;--panel2:#151824;--text:#e8ebf5;--muted:#9aa3b2;
      --accent:#7c5cff;--accent2:#5fd4ff;--danger:#ff6b6b;
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,sans-serif;color:var(--text);
      background:
        radial-gradient(1200px 800px at 10% -10%,#1c1f2b 0%,transparent 60%),
        radial-gradient(1000px 700px at 110% 0%,#151a2d 0%,transparent 60%),
        var(--bg);
      height:100vh;display:flex;flex-direction:column;
    }
    header{
      display:flex;align-items:center;justify-content:space-between;
      padding:14px 18px;border-bottom:1px solid rgba(255,255,255,.06);
      background:linear-gradient(180deg,rgba(255,255,255,.03),transparent);
      position:sticky;top:0;z-index:10;
    }
    .brand{display:flex;gap:10px;align-items:center;font-weight:700}
    .dot{width:8px;height:8px;border-radius:50%;background:var(--accent2);box-shadow:0 0 12px var(--accent2)}
    .toolbar{display:flex;gap:8px;align-items:center}
    button{
      background:var(--panel2);border:1px solid rgba(255,255,255,.08);
      color:var(--text);padding:8px 12px;border-radius:10px;cursor:pointer;font-weight:600;
    }
    button.primary{background:linear-gradient(90deg,#6b6bff,#8d5cff);border:none}
    button.ghost{background:transparent}
    button:disabled{opacity:.5;cursor:not-allowed}

    main{flex:1;display:grid;grid-template-columns:repeat(3,1fr);gap:12px;padding:12px;overflow:auto}
    .col{
      background:var(--panel);border:1px solid rgba(255,255,255,.06);
      border-radius:var(--radius);padding:10px;display:flex;flex-direction:column;min-height:300px;
    }
    .col h3{margin:4px 4px 8px;font-size:14px;color:var(--muted);display:flex;justify-content:space-between}
    .count{font-size:12px;color:var(--muted)}
    .dropzone{flex:1;display:flex;flex-direction:column;gap:8px;min-height:120px;padding:4px;border-radius:12px}
    .dropzone.dragover{outline:2px dashed var(--accent);background:rgba(124,92,255,.06)}

    .card{
      background:var(--panel2);border:1px solid rgba(255,255,255,.08);
      border-radius:14px;padding:10px;cursor:grab;display:flex;flex-direction:column;gap:6px;
    }
    .card .title{font-weight:700}
    .meta{display:flex;gap:6px;flex-wrap:wrap;font-size:12px;color:var(--muted)}
    .badge{
      padding:2px 6px;border-radius:999px;font-size:11px;font-weight:700;
      background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.08);
    }
    .badge.priority{background:rgba(255,107,107,.12);border-color:rgba(255,107,107,.5);color:#ffb3b3}
    .badge.planned{background:rgba(95,212,255,.12);border-color:rgba(95,212,255,.45);color:#b6edff}
    .linkbtn{
      font-size:12px;text-decoration:none;color:#c7d2ff;background:rgba(124,92,255,.12);
      padding:4px 8px;border-radius:8px;display:inline-flex;gap:6px;align-items:center;
      border:1px solid rgba(124,92,255,.4);width:max-content;
    }

    /* Modal */
    .backdrop{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;z-index:50}
    .modal{width:520px;max-width:95vw;background:var(--panel);border:1px solid rgba(255,255,255,.08);
      border-radius:16px;padding:14px;display:flex;flex-direction:column;gap:8px}
    .modal header{position:static;background:none;border:none;padding:0;margin-bottom:6px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    label{font-size:12px;color:var(--muted)}
    input,textarea,select{
      width:100%;padding:8px;border-radius:10px;border:1px solid rgba(255,255,255,.1);
      background:var(--panel2);color:var(--text);outline:none;
    }
    textarea{min-height:80px;resize:vertical}
    .modal .actions{display:flex;justify-content:flex-end;gap:8px;margin-top:6px}

    .hint{font-size:12px;color:var(--muted)}
  </style>
</head>
<body>
<header>
  <div class="brand"><span class="dot"></span> JM Kanban <span class="hint">Team board</span></div>
  <div class="toolbar">
    <button class="ghost" id="btnRefresh">â†» Refresh</button>
    <button class="primary" id="btnAdd">ï¼‹ Add task</button>
  </div>
</header>

<main>
  <section class="col" data-status="To Do">
    <h3><span>To Do</span> <span class="count" id="countTodo">0</span></h3>
    <div class="dropzone" id="todoZone"></div>
  </section>

  <section class="col" data-status="Doing">
    <h3><span>Doing</span> <span class="count" id="countDoing">0</span></h3>
    <div class="dropzone" id="doingZone"></div>
  </section>

  <section class="col" data-status="Done">
    <h3><span>Done</span> <span class="count" id="countDone">0</span></h3>
    <div class="dropzone" id="doneZone"></div>
  </section>
</main>

<!-- Modal -->
<div class="backdrop" id="backdrop">
  <div class="modal">
    <header style="display:flex;justify-content:space-between;align-items:center;">
      <div style="font-weight:800">Create task</div>
      <button class="ghost" id="btnClose">âœ•</button>
    </header>

    <label>Title</label>
    <input id="taskTitle" placeholder="e.g. Follow up client A2-3">

    <div class="row">
      <div>
        <label>Assignee (Name)</label>
        <input id="taskAssigneeName" placeholder="e.g. Lita">
      </div>
      <div>
        <label>Assignee Email</label>
        <input id="taskAssigneeEmail" placeholder="e.g. lita@cloverth.net">
      </div>
    </div>

    <div class="row">
      <div>
        <label>Due date</label>
        <input id="taskDueDate" type="date">
      </div>
      <div>
        <label>Status</label>
        <select id="taskStatus">
          <option>To Do</option>
          <option>Doing</option>
          <option>Done</option>
        </select>
      </div>
    </div>

    <div class="row">
      <div>
        <label>Priority</label>
        <select id="taskPriority">
          <option value="Priority">Priority (ä¼˜å…ˆ)</option>
          <option value="Planned" selected>Planned (è®¡åˆ’)</option>
        </select>
      </div>
      <div>
        <label>Google Link (é™„ä»¶)</label>
        <input id="taskLink" placeholder="Paste Google Drive/Docs link">
      </div>
    </div>

    <label>Description</label>
    <textarea id="taskDesc" placeholder="Details..."></textarea>

    <div class="actions">
      <button id="btnCancel">Cancel</button>
      <button class="primary" id="btnSave">Save</button>
    </div>
  </div>
</div>

<script>
/** ================== CONFIG ================== **/
const API_BASE = "https://script.google.com/macros/s/AKfycbw5DMgrN-uG_FzPyn83P8SIg9E37BLipNTwnC5mEy2RyS_CIPTj_3XiOE-y5TahZDKP/exec";
const COMPANY_DOMAIN = "cloverth.net";
const ADMIN_EMAILS = ["danielchang@cloverth.net"]; // å‰ç«¯ä»…ç”¨äºŽæ˜¾ç¤º

let currentUserEmail = "";
let tasks = [];

/** ================== JSONP CORE ================== **/
function jsonp(action, data={}){
  return new Promise((resolve,reject)=>{
    const cb = "cb_"+Math.random().toString(36).slice(2);
    window[cb] = (res)=>{
      delete window[cb];
      script.remove();
      resolve(res);
    };
    const payload = btoa(unescape(encodeURIComponent(JSON.stringify(data))));
    const url = `${API_BASE}?action=${encodeURIComponent(action)}&data=${encodeURIComponent(payload)}&callback=${cb}&_=${Date.now()}`;
    const script = document.createElement("script");
    script.src = url;
    script.onerror = ()=>{ delete window[cb]; script.remove(); reject(new Error("JSONP load error")); };
    document.body.appendChild(script);
  });
}

/** ================== LOGIN ================== **/
function isAdmin(email){
  return ADMIN_EMAILS.includes(String(email||"").toLowerCase());
}

async function init(){
  currentUserEmail = localStorage.getItem("jm_user_email") || "";
  while(true){
    if(!currentUserEmail){
      currentUserEmail = prompt("è¯·è¾“å…¥å…¬å¸é‚®ç®±ï¼ˆ@cloverth.netï¼‰ç”¨äºŽç™»å½•ï¼š")?.trim().toLowerCase() || "";
    }
    if(currentUserEmail.endsWith("@"+COMPANY_DOMAIN)){
      localStorage.setItem("jm_user_email", currentUserEmail);
      break;
    }
    alert("åªå…è®¸ä½¿ç”¨ @cloverth.net é‚®ç®±ç™»å½•ã€‚");
    currentUserEmail = "";
  }

  await loadTasks();
  setInterval(loadTasks, 30000);
}

/** ================== TASKS ================== **/
async function loadTasks(){
  const res = await jsonp("listTasks",{loginEmail:currentUserEmail});
  if(!res.ok){ alert("Load tasks error: "+res.error); return; }
  tasks = res.tasks || [];
  render();
}

async function createTask(payload){
  const res = await jsonp("createTask", payload);
  if(!res.ok){ alert("Create error: "+res.error); return; }
  await loadTasks();
}

async function updateStatus(id, status){
  const res = await jsonp("updateTaskStatus",{id,status,loginEmail:currentUserEmail});
  if(!res.ok){ alert("Update status error: "+res.error); return; }
  await loadTasks();
}

function render(){
  const byStatus = {"To Do":[], "Doing":[], "Done":[]};
  tasks.forEach(t=>{
    const s = t.status || "To Do";
    if(!byStatus[s]) byStatus[s]=[];
    byStatus[s].push(t);
  });

  // Priority æŽ’åºï¼šPriority ç½®é¡¶
  for(const s in byStatus){
    byStatus[s].sort((a,b)=>{
      const pa = (a.priority==="Priority")?0:1;
      const pb = (b.priority==="Priority")?0:1;
      if(pa!==pb) return pa-pb;
      return new Date(b.createdAt)-new Date(a.createdAt);
    });
  }

  renderZone("todoZone", byStatus["To Do"]);
  renderZone("doingZone", byStatus["Doing"]);
  renderZone("doneZone", byStatus["Done"]);

  document.getElementById("countTodo").textContent = byStatus["To Do"].length;
  document.getElementById("countDoing").textContent = byStatus["Doing"].length;
  document.getElementById("countDone").textContent = byStatus["Done"].length;
}

function renderZone(zoneId, list){
  const zone = document.getElementById(zoneId);
  zone.innerHTML = "";
  if(!list.length){
    const empty = document.createElement("div");
    empty.className="hint";
    empty.textContent="No tasks";
    zone.appendChild(empty);
    return;
  }

  list.forEach(t=>{
    const card = document.createElement("div");
    card.className="card";
    card.draggable=true;
    card.dataset.id=t.id;

    const priClass = (t.priority==="Priority")?"priority":"planned";
    const priText = t.priority || "Planned";

    card.innerHTML = `
      <div class="title">${escapeHtml(t.title||"(untitled)")}</div>
      <div class="meta">
        <span class="badge ${priClass}">${priText}</span>
        ${t.assigneeName?`<span class="badge">@${escapeHtml(t.assigneeName)}</span>`:""}
        ${t.dueDate?`<span class="badge">Due: ${escapeHtml(t.dueDate)}</span>`:""}
      </div>
      ${t.description?`<div class="hint">${escapeHtml(t.description)}</div>`:""}
      ${t.link?`<a class="linkbtn" href="${t.link}" target="_blank">ðŸ“Ž Open File</a>`:""}
    `;

    card.addEventListener("dragstart", onDragStart);
    zone.appendChild(card);
  });
}

/** ================== DND ================== **/
let dragId=null;

function onDragStart(ev){
  dragId = ev.currentTarget.dataset.id;
  ev.dataTransfer.setData("text/plain", dragId);
}

document.querySelectorAll(".dropzone").forEach(zone=>{
  zone.addEventListener("dragover",(e)=>{
    e.preventDefault();
    zone.classList.add("dragover");
  });
  zone.addEventListener("dragleave",()=>zone.classList.remove("dragover"));
  zone.addEventListener("drop", async (e)=>{
    e.preventDefault();
    zone.classList.remove("dragover");
    const id = e.dataTransfer.getData("text/plain") || dragId;
    if(!id) return;
    const col = zone.closest(".col");
    const newStatus = col.dataset.status;
    await updateStatus(id, newStatus);
  });
});

/** ================== MODAL ================== **/
const backdrop = document.getElementById("backdrop");
document.getElementById("btnAdd").onclick=()=>openModal();
document.getElementById("btnClose").onclick=closeModal;
document.getElementById("btnCancel").onclick=closeModal;
document.getElementById("btnRefresh").onclick=loadTasks;

function openModal(){
  backdrop.style.display="flex";
  // reset
  ["taskTitle","taskAssigneeName","taskAssigneeEmail","taskDesc","taskLink"].forEach(id=>{
    document.getElementById(id).value="";
  });
  document.getElementById("taskPriority").value="Planned";
  document.getElementById("taskStatus").value="To Do";
  document.getElementById("taskDueDate").value="";
}
function closeModal(){ backdrop.style.display="none"; }

document.getElementById("btnSave").onclick=async ()=>{
  const title = document.getElementById("taskTitle").value.trim();
  const assigneeName = document.getElementById("taskAssigneeName").value.trim();
  const assigneeEmail = document.getElementById("taskAssigneeEmail").value.trim().toLowerCase();
  const dueDate = document.getElementById("taskDueDate").value;
  const status = document.getElementById("taskStatus").value;
  const priority = document.getElementById("taskPriority").value;
  const description = document.getElementById("taskDesc").value.trim();
  const link = document.getElementById("taskLink").value.trim();

  if(!title){ alert("Title required"); return; }
  if(assigneeEmail && !assigneeEmail.endsWith("@"+COMPANY_DOMAIN)){
    alert("Assignee å¿…é¡»æ˜¯ @cloverth.net é‚®ç®±");
    return;
  }

  await createTask({
    title,assigneeName,assigneeEmail,dueDate,status,priority,description,link,
    loginEmail: currentUserEmail
  });
  closeModal();
};

/** ================== UTILS ================== **/
function escapeHtml(s){
  return String(s||"").replace(/[&<>"']/g,m=>({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
  }[m]));
}

init();
</script>
</body>
</html>
