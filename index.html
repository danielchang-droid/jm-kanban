<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>JM Kanban â€” Team</title>
  <style>
    :root{
      --bg:#0b0c10;
      --panel:#11131a;
      --panel-2:#151824;
      --text:#e8ebf5;
      --muted:#9aa3b2;
      --accent:#7c5cff;
      --accent-2:#3ddc97;
      --danger:#ff7a7a;
      --warning:#ffb454;
      --ok:#7ee787;

      --radius:16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      color:var(--text);
      height:100vh;
      background:
        radial-gradient(1200px 800px at 10% -10%, #1c1f2b 0%, transparent 60%),
        radial-gradient(1000px 700px at 110% 0%, #151a2d 0%, transparent 60%),
        var(--bg);
      display:flex;
      flex-direction:column;
    }

    header{
      height:64px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:0 16px;
      border-bottom:1px solid #1c2030;
      background:rgba(5,6,10,.6);
      backdrop-filter: blur(8px);
    }
    .brand{
      display:flex;gap:10px;align-items:center;font-weight:700;
    }
    .dot{width:9px;height:9px;border-radius:50%;background:var(--accent)}
    .sub{font-weight:500;color:var(--muted);font-size:13px}

    .right{
      display:flex;gap:8px;align-items:center;
    }
    button{
      appearance:none;border:0;outline:0;cursor:pointer;
      background:var(--panel-2);color:var(--text);
      padding:8px 12px;border-radius:10px;
      font-weight:600;font-size:14px;
      border:1px solid #202538;
    }
    button.primary{background:var(--accent);border-color:transparent;}
    button.ghost{background:transparent;}
    button:disabled{opacity:.5;cursor:not-allowed}

    .layout{
      flex:1;display:grid;grid-template-columns:repeat(3,1fr);
      gap:12px;padding:12px;min-height:0;
    }
    .col{
      background:rgba(17,19,26,.9);
      border:1px dashed #242a3f;
      border-radius:var(--radius);
      display:flex;flex-direction:column;min-height:0;
    }
    .col h3{
      margin:0;padding:10px 12px;font-size:14px;color:var(--muted);
      display:flex;justify-content:space-between;align-items:center;
      border-bottom:1px solid #1f2435;
    }
    .col .count{font-size:12px;background:#1c2030;padding:2px 8px;border-radius:999px;color:var(--text)}
    .list{
      padding:8px;display:flex;flex-direction:column;gap:8px;
      overflow:auto;min-height:0;
    }

    .card{
      background:var(--panel-2);
      border:1px solid #23283b;border-radius:14px;
      padding:10px;display:flex;flex-direction:column;gap:6px;
      cursor:grab;
    }
    .title{font-weight:700;font-size:15px}
    .desc{color:var(--muted);font-size:13px;white-space:pre-wrap}
    .meta{display:flex;gap:6px;flex-wrap:wrap;font-size:12px;color:var(--muted)}
    .pill{
      background:#1c2030;border:1px solid #2a314a;
      padding:2px 7px;border-radius:999px;color:var(--text);
      display:inline-flex;align-items:center;gap:4px;
    }
    .pill.priority-Urgent{border-color:var(--danger);color:#ffd7d7}
    .pill.priority-Planned{border-color:var(--warning);color:#ffe4b8}

    .actions{display:flex;gap:6px;margin-top:4px}
    .tiny{font-size:12px;padding:6px 8px;border-radius:8px}

    /* modal */
    .modal-backdrop{
      position:fixed;inset:0;background:rgba(0,0,0,.5);
      display:none;align-items:center;justify-content:center;z-index:10;
    }
    .modal{
      width:min(720px,92vw);
      background:var(--panel);
      border:1px solid #23283b;border-radius:18px;
      padding:14px;
      box-shadow:0 10px 40px rgba(0,0,0,.6);
    }
    .modal h2{margin:0 0 8px 0;font-size:18px}
    .grid{
      display:grid;grid-template-columns:1fr 1fr;gap:10px;
    }
    label{font-size:12px;color:var(--muted);display:flex;flex-direction:column;gap:4px}
    input,textarea,select{
      background:var(--panel-2);color:var(--text);
      border:1px solid #23283b;border-radius:10px;
      padding:8px;font-size:14px;outline:none;
    }
    textarea{min-height:70px;resize:vertical}
    .modal .footer{display:flex;justify-content:flex-end;gap:8px;margin-top:10px}
    .hint{font-size:12px;color:var(--muted)}
  </style>
</head>
<body>
<header>
  <div class="brand">
    <span class="dot"></span>
    <div>
      JM Kanban
      <div class="sub">Team board</div>
    </div>
  </div>
  <div class="right">
    <div id="userLabel" class="sub"></div>
    <button id="refreshBtn">Refresh</button>
    <button id="addBtn" class="primary">+ Add task</button>
  </div>
</header>

<main class="layout">
  <section class="col" data-status="To Do">
    <h3>To Do <span class="count" id="countTodo">0</span></h3>
    <div class="list" id="listTodo"></div>
  </section>
  <section class="col" data-status="Doing">
    <h3>Doing <span class="count" id="countDoing">0</span></h3>
    <div class="list" id="listDoing"></div>
  </section>
  <section class="col" data-status="Done">
    <h3>Done <span class="count" id="countDone">0</span></h3>
    <div class="list" id="listDone"></div>
  </section>
</main>

<!-- modal -->
<div class="modal-backdrop" id="backdrop">
  <div class="modal">
    <h2>Create task</h2>
    <div class="grid">
      <label>Title
        <input id="fTitle" placeholder="e.g. Follow up client A2-..." />
      </label>

      <label>Assignee email (@cloverth.net)
        <input id="fAssigneeEmail" placeholder="lita@cloverth.net" />
      </label>

      <label>Assignee name
        <input id="fAssigneeName" placeholder="Lita" />
      </label>

      <label>Due date
        <input id="fDueDate" type="date" />
      </label>

      <label>Priority
        <select id="fPriority">
          <option>Normal</option>
          <option>Planned</option>
          <option>Urgent</option>
        </select>
      </label>

      <label>Status
        <select id="fStatus">
          <option>To Do</option>
          <option>Doing</option>
          <option>Done</option>
        </select>
        <div class="hint">Done will ask creator to approve</div>
      </label>

      <label style="grid-column:1/-1">Google Link (optional)
        <input id="fGoogleLink" placeholder="https://docs.google.com/..." />
      </label>

      <label style="grid-column:1/-1">Description
        <textarea id="fDesc" placeholder="Details..."></textarea>
      </label>
    </div>
    <div class="footer">
      <button id="cancelBtn" class="ghost">Cancel</button>
      <button id="saveBtn" class="primary">Save</button>
    </div>
  </div>
</div>

<script>
/************
 * CONFIG
 ************/
const API_BASE = "https://script.google.com/macros/s/AKfycbw5DMgrN-uG_FzPyn83P8SIg9E37BLipNTwnC5mEy2RyS_CIPTj_3XiOE-y5TahZDKP/exec"; // <-- ä½ çš„åŽç«¯ exec
const DOMAIN = "@cloverth.net";

/************
 * JSONP helper
 ************/
function jsonp(url, params={}){
  return new Promise((resolve,reject)=>{
    const cb = "cb_"+Math.random().toString(36).slice(2);
    params.callback = cb;
    const qs = new URLSearchParams(params).toString();
    const script = document.createElement("script");
    script.src = url + (url.includes("?")?"&":"?") + qs;
    script.onerror = ()=>{ delete window[cb]; script.remove(); reject(new Error("JSONP load error")); };
    window[cb] = (res)=>{
      delete window[cb];
      script.remove();
      resolve(res);
    };
    document.body.appendChild(script);
  });
}

/************
 * State
 ************/
let currentUserEmail = "";
let isAdmin = false;
let tasks = [];

/************
 * Login
 ************/
async function login(){
  currentUserEmail = localStorage.getItem("jm_user_email") || "";
  if(!currentUserEmail){
    currentUserEmail = prompt("Please enter your company email:")?.trim().toLowerCase() || "";
    if(currentUserEmail) localStorage.setItem("jm_user_email", currentUserEmail);
  }
  if(!currentUserEmail) throw new Error("No email");

  const res = await jsonp(API_BASE, { action:"login", email: currentUserEmail });
  if(!res.ok) throw new Error(res.error || "Login failed");
  isAdmin = !!res.data.isAdmin;
  document.getElementById("userLabel").textContent = currentUserEmail + (isAdmin?" (admin)":"");
}

/************
 * Load tasks
 ************/
function priorityRank(p){
  return p==="Urgent"?0 : p==="Planned"?1 : 2;
}
async function loadTasks(){
  const res = await jsonp(API_BASE, { action:"listTasks", email: currentUserEmail });
  if(!res.ok) throw new Error(res.error || "Load failed");
  tasks = res.data || [];

  // sort: priority -> dueDate -> createdAt
  tasks.sort((a,b)=>{
    const pr = priorityRank(a.priority) - priorityRank(b.priority);
    if(pr!==0) return pr;
    const da = a.dueDate ? new Date(a.dueDate).getTime() : Infinity;
    const db = b.dueDate ? new Date(b.dueDate).getTime() : Infinity;
    if(da!==db) return da-db;
    return new Date(a.createdAt||0)-new Date(b.createdAt||0);
  });

  render();
}

/************
 * Render
 ************/
function render(){
  const map = {
    "To Do": document.getElementById("listTodo"),
    "Doing": document.getElementById("listDoing"),
    "Done": document.getElementById("listDone"),
    "Approved": document.getElementById("listDone"),
  };
  Object.values(map).forEach(el=> el.innerHTML="");

  let cTodo=0,cDoing=0,cDone=0;

  tasks.forEach(t=>{
    const status = t.status || "To Do";
    const list = map[status] || map["To Do"];
    const card = document.createElement("div");
    card.className="card";
    card.draggable=true;
    card.dataset.id=t.id;

    const due = t.dueDate ? new Date(t.dueDate).toISOString().slice(0,10) : "";
    const linkBlock = t.googleLink ? `<div class="meta"><a href="${t.googleLink}" target="_blank">ðŸ“Ž Open Link</a></div>` : "";

    card.innerHTML=`
      <div class="title">${escapeHtml(t.title||"")}</div>
      <div class="desc">${escapeHtml(t.description||"")}</div>
      ${linkBlock}
      <div class="meta">
        <span class="pill">@${escapeHtml(t.assigneeName||t.assigneeEmail||"")}</span>
        ${t.priority?`<span class="pill priority-${escapeHtml(t.priority)}">${escapeHtml(t.priority)}</span>`:""}
        ${due?`<span class="pill">Due: ${due}</span>`:""}
        ${t.createdBy?`<span class="pill">By: ${escapeHtml(t.createdBy)}</span>`:""}
      </div>
      <div class="actions">
        <select class="tiny statusSel">
          <option ${status==="To Do"?"selected":""}>To Do</option>
          <option ${status==="Doing"?"selected":""}>Doing</option>
          <option ${status==="Done"?"selected":""}>Done</option>
          <option ${status==="Approved"?"selected":""}>Approved</option>
        </select>
        ${isAdmin || currentUserEmail===t.createdBy ? `<button class="tiny editBtn">Edit</button>`:""}
      </div>
    `;

    // status dropdown
    card.querySelector(".statusSel").addEventListener("change", async (ev)=>{
      const newStatus = ev.target.value;
      await updateTask(t.id, { status:newStatus });
    });

    // drag handlers
    card.addEventListener("dragstart",(e)=>{
      e.dataTransfer.setData("text/plain", t.id);
    });

    list.appendChild(card);

    if(status==="To Do") cTodo++;
    else if(status==="Doing") cDoing++;
    else cDone++;
  });

  document.getElementById("countTodo").textContent=cTodo;
  document.getElementById("countDoing").textContent=cDoing;
  document.getElementById("countDone").textContent=cDone;
}

function escapeHtml(s){
  return String(s||"").replace(/[&<>"']/g,(c)=>({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
  }[c]));
}

/************
 * Update task
 ************/
async function updateTask(id, patch){
  const res = await jsonp(API_BASE, { action:"updateTask", email:currentUserEmail, id, ...patch });
  if(!res.ok){ alert(res.error||"Update failed"); return; }
  await loadTasks();
}

/************
 * Add task modal
 ************/
const backdrop = document.getElementById("backdrop");
document.getElementById("addBtn").onclick=()=>{ backdrop.style.display="flex"; };
document.getElementById("cancelBtn").onclick=()=>{ backdrop.style.display="none"; };

document.getElementById("saveBtn").onclick=async ()=>{
  const payload = {
    action:"addTask",
    email: currentUserEmail,
    title: document.getElementById("fTitle").value.trim(),
    description: document.getElementById("fDesc").value.trim(),
    assigneeName: document.getElementById("fAssigneeName").value.trim(),
    assigneeEmail: document.getElementById("fAssigneeEmail").value.trim().toLowerCase(),
    status: document.getElementById("fStatus").value,
    priority: document.getElementById("fPriority").value,
    dueDate: document.getElementById("fDueDate").value,
    googleLink: document.getElementById("fGoogleLink").value.trim()
  };

  if(!payload.title){ alert("Title required"); return; }
  if(!payload.assigneeEmail.endsWith(DOMAIN)){ alert("Assignee must be @cloverth.net"); return; }

  const res = await jsonp(API_BASE, payload);
  if(!res.ok){ alert(res.error||"Add failed"); return; }

  backdrop.style.display="none";
  // reset
  ["fTitle","fDesc","fAssigneeName","fAssigneeEmail","fDueDate","fGoogleLink"].forEach(id=>document.getElementById(id).value="");
  document.getElementById("fPriority").value="Normal";
  document.getElementById("fStatus").value="To Do";

  await loadTasks();
};

/************
 * Column drop zones
 ************/
document.querySelectorAll(".col").forEach(col=>{
  col.addEventListener("dragover",(e)=> e.preventDefault());
  col.addEventListener("drop", async (e)=>{
    e.preventDefault();
    const id = e.dataTransfer.getData("text/plain");
    const newStatus = col.dataset.status;
    await updateTask(id, { status:newStatus });
  });
});

/************
 * Init
 ************/
(async function init(){
  try{
    await login();
    await loadTasks();
    setInterval(loadTasks, 30000);
    document.getElementById("refreshBtn").onclick = loadTasks;
  }catch(err){
    console.error(err);
    alert("Init error: " + err.message);
  }
})();
</script>
</body>
</html>
