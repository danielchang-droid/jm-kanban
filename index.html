<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>JM Kanban – Team</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0b0c10;--panel:#11131a;--panel-2:#151824;--text:#e8ebf5;--muted:#9aa3b2;
      --accent:#7c5cff;--urgent:#ff6b6b;--planned:#ffd166;--normal:#6ee7b7;
      --border:rgba(255,255,255,.08);--radius:16px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui;background:
      radial-gradient(1200px 800px at 10% -10%, #1c1f2b 0%, transparent 60%),
      radial-gradient(1000px 700px at 110% 0%, #151a2d 0%, transparent 60%),
      var(--bg);
      color:var(--text);height:100vh;display:flex;flex-direction:column;
    }
    header{
      display:flex;align-items:center;gap:12px;padding:14px 18px;border-bottom:1px solid var(--border);
      background:rgba(10,11,16,.9);backdrop-filter:blur(8px);
      position:sticky;top:0;z-index:10;
    }
    .logo{display:flex;align-items:center;gap:8px;font-weight:700}
    .dot{width:8px;height:8px;border-radius:50%;background:var(--accent);box-shadow:0 0 14px var(--accent)}
    .spacer{flex:1}
    .btn{
      background:var(--panel-2);border:1px solid var(--border);color:var(--text);
      padding:8px 12px;border-radius:12px;cursor:pointer;font-weight:600;
    }
    .btn.primary{background:linear-gradient(180deg,#8b74ff,#6f55ff);border:none}
    .btn.ghost{background:transparent}
    .chip{font-size:12px;padding:4px 8px;border-radius:999px;border:1px solid var(--border);color:var(--muted)}
    .chip.urgent{color:var(--urgent);border-color:rgba(255,107,107,.5)}
    .chip.planned{color:var(--planned);border-color:rgba(255,209,102,.5)}
    .chip.normal{color:var(--normal);border-color:rgba(110,231,183,.5)}

    main{flex:1;display:grid;grid-template-columns:repeat(3,1fr);gap:14px;padding:14px}
    .col{
      background:rgba(17,19,26,.7);border:1px dashed var(--border);border-radius:18px;
      padding:12px;display:flex;flex-direction:column;min-height:0;
    }
    .col h3{margin:0 0 8px 0;font-size:18px;display:flex;align-items:center;gap:8px}
    .count{margin-left:auto;background:var(--panel-2);border:1px solid var(--border);
      width:28px;height:28px;display:grid;place-items:center;border-radius:999px;font-size:12px}
    .list{flex:1;overflow:auto;display:flex;flex-direction:column;gap:10px;padding-right:4px}
    .empty{color:var(--muted);font-size:13px;text-align:center;margin-top:20px}

    .card{
      background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:12px;
      box-shadow:0 10px 30px rgba(0,0,0,.35);cursor:grab;
    }
    .card-title{font-weight:700;margin-bottom:4px}
    .card-desc{font-size:13px;color:var(--muted);white-space:pre-wrap;max-height:3.6em;overflow:hidden}
    .meta{display:flex;flex-wrap:wrap;gap:6px;margin-top:8px}
    .meta .chip{font-weight:600}
    .row{display:flex;align-items:center;gap:8px;margin-top:8px}
    select,input,textarea{
      width:100%;background:var(--panel-2);border:1px solid var(--border);color:var(--text);
      padding:8px 10px;border-radius:10px;font-size:14px;outline:none;
    }
    textarea{min-height:90px;resize:vertical}

    /* Modal */
    .backdrop{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;z-index:100}
    .modal{
      position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);
      width:min(920px,94vw);max-height:90vh;overflow:auto;
      background:var(--panel);border:1px solid var(--border);border-radius:18px;padding:16px;
      display:none;z-index:101;
    }
    .modal h2{margin:0 0 12px 0}
    .grid{
      display:grid;grid-template-columns:1fr 1fr;gap:10px;
    }
    .grid-1{grid-template-columns:1fr}
    .modal-footer{display:flex;justify-content:flex-end;gap:8px;margin-top:12px}
    .close{float:right;cursor:pointer;font-size:18px;color:var(--muted)}
    .comment{
      background:var(--panel-2);border:1px solid var(--border);border-radius:12px;padding:8px;margin-top:6px;
      font-size:13px;
    }
    .comment .who{color:var(--muted);font-size:12px;margin-bottom:4px}

    @media (max-width: 900px){
      main{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
<header>
  <div class="logo"><span class="dot"></span>JM Kanban</div>
  <div class="chip" id="userChip">not logged in</div>
  <div class="spacer"></div>
  <button class="btn ghost" id="refreshBtn">Refresh</button>
  <button class="btn primary" id="addBtn">+ Add task</button>
  <button class="btn" id="logoutBtn">Logout</button>
</header>

<main>
  <section class="col" data-status="To Do">
    <h3>To Do <span class="count" id="c-todo">0</span></h3>
    <div class="list" id="todoList"></div>
  </section>
  <section class="col" data-status="Doing">
    <h3>Doing <span class="count" id="c-doing">0</span></h3>
    <div class="list" id="doingList"></div>
  </section>
  <section class="col" data-status="Done">
    <h3>Done <span class="count" id="c-done">0</span></h3>
    <div class="list" id="doneList"></div>
  </section>
</main>

<div class="backdrop" id="backdrop"></div>

<!-- Edit / Create Modal -->
<div class="modal" id="editModal">
  <div class="close" onclick="closeModal()">✕</div>
  <h2 id="editTitle">Create task</h2>

  <div class="grid">
    <div>
      <label>Title</label>
      <input id="f-title" placeholder="e.g. Follow up client A2-..." />
    </div>
    <div>
      <label>Assignee (name)</label>
      <input id="f-assigneeName" placeholder="e.g. Lita" />
    </div>
    <div>
      <label>Assignee (email)</label>
      <input id="f-assigneeEmail" placeholder="name@cloverth.net" />
    </div>
    <div>
      <label>Priority</label>
      <select id="f-priority">
        <option>Urgent</option>
        <option>Planned</option>
        <option selected>Normal</option>
      </select>
    </div>
    <div>
      <label>Due date (required)</label>
      <input id="f-dueDate" type="date"/>
    </div>
    <div>
      <label>Status</label>
      <select id="f-status">
        <option>To Do</option>
        <option>Doing</option>
        <option>Done</option>
        <option>Approved</option>
      </select>
    </div>

    <div class="grid-1" style="grid-column:1/-1;">
      <label>Description (visible to assignee + creator)</label>
      <textarea id="f-desc"></textarea>
    </div>

    <div>
      <label>Link 1</label>
      <input id="f-link1" placeholder="Google Drive / Doc link"/>
    </div>
    <div>
      <label>Link 2</label>
      <input id="f-link2"/>
    </div>
    <div class="grid-1" style="grid-column:1/-1;">
      <label>Link 3</label>
      <input id="f-link3"/>
    </div>
  </div>

  <div class="modal-footer">
    <button class="btn ghost" onclick="closeModal()">Cancel</button>
    <button class="btn primary" onclick="saveTask()">Save</button>
  </div>
</div>

<!-- Detail Modal -->
<div class="modal" id="detailModal">
  <div class="close" onclick="closeDetail()">✕</div>
  <h2 id="d-title"></h2>
  <div id="d-desc" class="card-desc"></div>
  <div class="meta" id="d-meta"></div>
  <div id="d-links" class="meta" style="margin-top:10px;"></div>

  <div id="d-returned" class="comment" style="display:none;"></div>

  <h3 style="margin-top:14px;">Comments</h3>
  <div id="d-comments"></div>
  <div style="margin-top:8px;">
    <textarea id="d-newComment" placeholder="Write a comment..."></textarea>
    <div class="modal-footer">
      <button class="btn primary" onclick="addComment()">Post comment</button>
    </div>
  </div>

  <hr style="border-color:var(--border);margin:12px 0;">

  <div class="grid">
    <div>
      <label>Change status</label>
      <select id="d-status">
        <option>To Do</option>
        <option>Doing</option>
        <option>Done</option>
        <option>Approved</option>
      </select>
    </div>
    <div id="creatorActions" style="display:none;">
      <label>Creator actions</label>
      <div style="display:flex;gap:6px;">
        <button class="btn primary" onclick="approveTask()">Approve</button>
        <button class="btn" onclick="openReturnBox()">Return to Doing</button>
      </div>
    </div>
  </div>

  <div id="returnBox" style="display:none;margin-top:8px;">
    <label>Return reason</label>
    <textarea id="returnReason"></textarea>
    <div class="modal-footer">
      <button class="btn" onclick="submitReturn()">Submit Return</button>
    </div>
  </div>

  <div class="modal-footer">
    <button class="btn" onclick="archiveTask()">Archive</button>
    <button class="btn ghost" onclick="closeDetail()">Close</button>
  </div>
</div>

<script>
/***************
 * JM Kanban Frontend v2
 ***************/
const API_BASE = "https://script.google.com/macros/s/AKfycbw5DMgrN-uG_FzPyn83P8SIg9E37BLipNTwnC5mEy2RyS_CIPTj_3XiOE-y5TahZDKP/exec";

let directory = [];
let allTasks = [];
let me = "";
let myName = "";
let isAdmin = false;
let currentEditId = null;
let currentDetailTask = null;

const PRIORITY_WEIGHT = { "Urgent": 0, "Planned": 1, "Normal": 2 };

function qs(id){ return document.getElementById(id); }

async function api(action, payload={}){
  const res = await fetch(API_BASE, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ action, ...payload })
  });
  return res.json();
}

function promptLogin(){
  let stored = localStorage.getItem("jm_user_email") || "";
  stored = stored.trim().toLowerCase();
  if(stored){
    me = stored;
    return Promise.resolve();
  }
  let email = prompt("Please enter your company email to login (xxx@cloverth.net):");
  email = (email || "").trim().toLowerCase();
  if(email){
    localStorage.setItem("jm_user_email", email);
    me = email;
  }
  return Promise.resolve();
}

async function init(){
  await promptLogin();
  const dirRes = await api("listDirectory");
  directory = dirRes.directory || [];

  const found = directory.find(d => d.email === me);
  if(!found){
    alert("Email not found in Directory. Please contact admin.");
    localStorage.removeItem("jm_user_email");
    location.reload();
    return;
  }
  myName = found.name || me.split("@")[0];
  isAdmin = !!found.admin;

  qs("userChip").textContent = `${me}${isAdmin ? " (admin)" : ""}`;

  await loadTasks();
  wireDnD();
  setInterval(loadTasks, 30000);
}

async function loadTasks(){
  const res = await api("listTasks");
  if(!res.ok){ alert(res.error || "Load tasks error"); return; }
  allTasks = (res.tasks || []).filter(t => !t.archived);

  // filter view by role
  let viewTasks = allTasks.filter(t => {
    if(isAdmin) return true;
    return (t.assigneeEmail === me) || (t.createdBy === me);
  });

  render(viewTasks);
}

function render(tasks){
  const todo = tasks.filter(t => t.status === "To Do");
  const doing = tasks.filter(t => t.status === "Doing");
  const done = tasks.filter(t => t.status === "Done");
  const approved = tasks.filter(t => t.status === "Approved");

  // sort in each column
  todo.sort(sortRule);
  doing.sort(sortRule);
  done.sort(sortRule);
  approved.sort(sortRule);

  drawList("todoList", todo);
  drawList("doingList", doing);
  drawList("doneList", done);

  qs("c-todo").textContent = todo.length;
  qs("c-doing").textContent = doing.length;
  qs("c-done").textContent = done.length;
}

function sortRule(a,b){
  const wa = PRIORITY_WEIGHT[a.priority] ?? 9;
  const wb = PRIORITY_WEIGHT[b.priority] ?? 9;
  if(wa !== wb) return wa - wb;
  const da = a.dueDate ? new Date(a.dueDate).getTime() : 9e18;
  const db = b.dueDate ? new Date(b.dueDate).getTime() : 9e18;
  return da - db;
}

function drawList(elId, list){
  const el = qs(elId);
  el.innerHTML = "";
  if(list.length === 0){
    el.innerHTML = `<div class="empty">No tasks</div>`;
    return;
  }
  list.forEach(t => el.appendChild(cardEl(t)));
}

function priorityChip(p){
  const cls = (p||"Normal").toLowerCase();
  return `<span class="chip ${cls}">${p||"Normal"}</span>`;
}

function cardEl(t){
  const div = document.createElement("div");
  div.className = "card";
  div.draggable = true;
  div.dataset.id = t.id;
  div.dataset.status = t.status;

  const canSeeDesc = isAdmin || t.assigneeEmail === me || t.createdBy === me;
  const desc = canSeeDesc ? (t.description || "") : "";

  div.innerHTML = `
    <div class="card-title">${escapeHtml(t.title || "(no title)")}</div>
    <div class="card-desc">${escapeHtml(desc)}</div>
    <div class="meta">
      <span class="chip">@${escapeHtml(t.assigneeName || t.assigneeEmail || "")}</span>
      ${priorityChip(t.priority)}
      <span class="chip">Due: ${t.dueDate ? fmtDate(t.dueDate) : "-"}</span>
      <span class="chip">By: ${escapeHtml(t.createdBy || "")}</span>
    </div>
  `;
  div.addEventListener("click", ()=>openDetail(t.id));
  div.addEventListener("dragstart", onDragStart);
  return div;
}

// ---- DnD ----
let dragId = null;

function wireDnD(){
  document.querySelectorAll(".col").forEach(col=>{
    col.addEventListener("dragover", e=>e.preventDefault());
    col.addEventListener("drop", onDrop);
  });
}
function onDragStart(e){
  dragId = e.currentTarget.dataset.id;
}
async function onDrop(e){
  if(!dragId) return;
  const newStatus = e.currentTarget.dataset.status;
  const task = allTasks.find(x=>x.id===dragId);
  if(!task) return;

  // permission
  const isAssignee = task.assigneeEmail === me;
  const isCreator = task.createdBy === me;

  if(newStatus==="Approved" && !(isCreator||isAdmin)){
    alert("Only creator/admin can approve.");
    return;
  }
  if(!(isAssignee||isCreator||isAdmin)){
    alert("No permission to move this task.");
    return;
  }

  await api("updateStatus", { id: dragId, status: newStatus, actorEmail: me });
  dragId=null;
  await loadTasks();
}

// ---- Create/Edit ----
qs("addBtn").onclick = ()=>openEdit(null);
qs("refreshBtn").onclick = loadTasks;
qs("logoutBtn").onclick = ()=>{
  localStorage.removeItem("jm_user_email");
  location.reload();
};

function openEdit(id){
  currentEditId = id;
  const t = id ? allTasks.find(x=>x.id===id) : null;

  qs("editTitle").textContent = id ? "Edit task" : "Create task";
  qs("f-title").value = t?.title || "";
  qs("f-assigneeName").value = t?.assigneeName || myName;
  qs("f-assigneeEmail").value = t?.assigneeEmail || me;
  qs("f-priority").value = t?.priority || "Normal";
  qs("f-status").value = t?.status || "To Do";
  qs("f-dueDate").value = t?.dueDate ? t.dueDate.slice(0,10) : "";
  qs("f-desc").value = t?.description || "";
  qs("f-link1").value = t?.link1 || "";
  qs("f-link2").value = t?.link2 || "";
  qs("f-link3").value = t?.link3 || "";

  showModal("editModal");
}

async function saveTask(){
  const title = qs("f-title").value.trim();
  const assigneeName = qs("f-assigneeName").value.trim();
  let assigneeEmail = qs("f-assigneeEmail").value.trim().toLowerCase();
  const priority = qs("f-priority").value;
  const status = qs("f-status").value;
  const dueDate = qs("f-dueDate").value;
  const description = qs("f-desc").value;
  const link1 = qs("f-link1").value.trim();
  const link2 = qs("f-link2").value.trim();
  const link3 = qs("f-link3").value.trim();

  if(!title){ alert("Title required"); return; }
  if(!dueDate){ alert("Due date required"); return; }

  // validate assignee exists in directory
  const d = directory.find(x=>x.email===assigneeEmail);
  if(!d){
    alert("Assignee email not found in Directory.");
    return;
  }

  const payload = {
    id: currentEditId,
    title, description,
    assigneeName: assigneeName || d.name || assigneeEmail.split("@")[0],
    assigneeEmail,
    status, priority, dueDate,
    link1, link2, link3,
    createdBy: currentEditId ? undefined : me,
  };

  const res = await api("upsertTask", payload);
  if(!res.ok){ alert(res.error||"Save error"); return; }
  closeModal();
  await loadTasks();
}

// ---- Detail ----
async function openDetail(id){
  const t = allTasks.find(x=>x.id===id);
  if(!t) return;
  currentDetailTask = t;

  const canSeeDesc = isAdmin || t.assigneeEmail===me || t.createdBy===me;
  qs("d-title").textContent = t.title;
  qs("d-desc").textContent = canSeeDesc ? (t.description||"") : "(hidden)";

  qs("d-meta").innerHTML = `
    <span class="chip">@${escapeHtml(t.assigneeName||t.assigneeEmail||"")}</span>
    ${priorityChip(t.priority)}
    <span class="chip">Due: ${t.dueDate ? fmtDate(t.dueDate) : "-"}</span>
    <span class="chip">By: ${escapeHtml(t.createdBy||"")}</span>
    <span class="chip">Status: ${escapeHtml(t.status||"")}</span>
  `;

  const links = [];
  if(t.link1) links.push(`<a class="chip" target="_blank" href="${t.link1}">Link1</a>`);
  if(t.link2) links.push(`<a class="chip" target="_blank" href="${t.link2}">Link2</a>`);
  if(t.link3) links.push(`<a class="chip" target="_blank" href="${t.link3}">Link3</a>`);
  qs("d-links").innerHTML = links.join(" ");

  // returned reason show
  if(t.returnedReason){
    qs("d-returned").style.display="block";
    qs("d-returned").innerHTML = `<div class="who">Returned reason</div>${escapeHtml(t.returnedReason)}`;
  }else{
    qs("d-returned").style.display="none";
  }

  drawComments(t);

  qs("d-status").value = t.status;
  qs("d-status").onchange = async ()=>{
    const ns = qs("d-status").value;
    const isAssignee = t.assigneeEmail===me;
    const isCreator = t.createdBy===me;
    if(ns==="Approved" && !(isCreator||isAdmin)){
      alert("Only creator/admin can approve.");
      qs("d-status").value = t.status;
      return;
    }
    if(!(isAssignee||isCreator||isAdmin)){
      alert("No permission.");
      qs("d-status").value = t.status;
      return;
    }
    await api("updateStatus",{id:t.id,status:ns,actorEmail:me});
    await loadTasks();
    closeDetail();
  };

  // creator actions
  const isCreator = t.createdBy===me;
  qs("creatorActions").style.display = (isCreator||isAdmin) ? "block":"none";
  qs("returnBox").style.display="none";

  showModal("detailModal");
}

function drawComments(t){
  const box = qs("d-comments");
  box.innerHTML = "";
  (t.comments||[]).forEach(c=>{
    const div=document.createElement("div");
    div.className="comment";
    div.innerHTML=`<div class="who">${escapeHtml(c.actorEmail||"")} · ${fmtDateTime(c.time)}</div>
      <div>${escapeHtml(c.text||"")}</div>`;
    box.appendChild(div);
  });
}

async function addComment(){
  if(!currentDetailTask) return;
  const text = qs("d-newComment").value.trim();
  if(!text) return;
  const res = await api("addComment",{id:currentDetailTask.id,text,actorEmail:me});
  if(!res.ok){ alert(res.error||"comment error"); return; }
  qs("d-newComment").value="";
  currentDetailTask = res.task;
  drawComments(currentDetailTask);
  await loadTasks();
}

async function approveTask(){
  const t=currentDetailTask;
  if(!t) return;
  const res=await api("approveTask",{id:t.id,actorEmail:me});
  if(!res.ok){ alert(res.error||"approve error"); return; }
  await loadTasks();
  closeDetail();
}

function openReturnBox(){
  qs("returnBox").style.display="block";
}

async function submitReturn(){
  const t=currentDetailTask;
  if(!t) return;
  const reason=qs("returnReason").value.trim();
  if(!reason){ alert("Please write reason"); return; }
  const res=await api("returnTask",{id:t.id,reason,actorEmail:me});
  if(!res.ok){ alert(res.error||"return error"); return; }
  qs("returnReason").value="";
  await loadTasks();
  closeDetail();
}

async function archiveTask(){
  const t=currentDetailTask;
  if(!t) return;
  if(!confirm("Archive this task?")) return;
  const res=await api("archiveTask",{id:t.id,actorEmail:me});
  if(!res.ok){ alert(res.error||"archive error"); return; }
  await loadTasks();
  closeDetail();
}

// ---- Modal helpers ----
function showModal(id){
  qs("backdrop").style.display="block";
  qs(id).style.display="block";
}
function closeModal(){
  qs("backdrop").style.display="none";
  qs("editModal").style.display="none";
}
function closeDetail(){
  qs("backdrop").style.display="none";
  qs("detailModal").style.display="none";
}

// ---- Utils ----
function fmtDate(d){
  try{ return new Date(d).toISOString().slice(0,10); }catch{return d;}
}
function fmtDateTime(d){
  try{ return new Date(d).toLocaleString(); }catch{return d;}
}
function escapeHtml(s){
  return (s||"").replace(/[&<>"']/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]));
}

init();
</script>
</body>
</html>
